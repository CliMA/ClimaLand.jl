<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Intro to multi-component models · ClimaLand.jl</title><meta name="title" content="Intro to multi-component models · ClimaLand.jl"/><meta property="og:title" content="Intro to multi-component models · ClimaLand.jl"/><meta property="twitter:title" content="Intro to multi-component models · ClimaLand.jl"/><meta name="description" content="Documentation for ClimaLand.jl."/><meta property="og:description" content="Documentation for ClimaLand.jl."/><meta property="twitter:description" content="Documentation for ClimaLand.jl."/><script data-outdated-warner src="../../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../../assets/documenter.js"></script><script src="../../../../search_index.js"></script><script src="../../../../siteinfo.js"></script><script src="../../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../../../../"><img src="../../../../assets/logo.svg" alt="ClimaLand.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../../../../">ClimaLand.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../../../../">Home</a></li><li><a class="tocitem" href="../../../../getting_started/">Getting Started</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1"><span class="docs-label">Running land simulations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-1-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1-1"><span class="docs-label">Bucket LSM</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Bucket/bucket_tutorial/">Introduction to the Land Bucket Model</a></li><li><a class="tocitem" href="../../Bucket/coupled_bucket/">Setting up a Coupled Simulation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-1-2" type="checkbox"/><label class="tocitem" for="menuitem-3-1-2"><span class="docs-label">Integrated soil+canopy modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../integrated/soil_canopy_tutorial/">Coupled Canopy and Soil</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-1-3" type="checkbox"/><label class="tocitem" for="menuitem-3-1-3"><span class="docs-label">Handling interactions between model components</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../integrated/handling_soil_fluxes/">Adjusting boundary conditions for the soil</a></li><li><a class="tocitem" href="../../../integrated/handling_snow_fluxes/">Adjusting boundary conditions for the snow</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">Running standalone component simulations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-2-1" type="checkbox"/><label class="tocitem" for="menuitem-3-2-1"><span class="docs-label">Soil modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Soil/boundary_conditions/">Boundary conditions</a></li><li><a class="tocitem" href="../../Soil/richards_equation/">Richards Equation</a></li><li><a class="tocitem" href="../../Soil/soil_energy_hydrology/">Energy and Hydrology</a></li><li><a class="tocitem" href="../../Soil/freezing_front/">Phase Changes</a></li><li><a class="tocitem" href="../../Soil/layered_soil/">Layered Soil</a></li><li><a class="tocitem" href="../../Soil/evaporation/">Coarse Sand Evaporation</a></li><li><a class="tocitem" href="../../Soil/evaporation_gilat_loess/">Gilat Loess Evaporation</a></li><li><a class="tocitem" href="../../Soil/sublimation/">Bare soil site</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-2-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2-2"><span class="docs-label">Canopy modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Canopy/canopy_tutorial/">Standalone Canopy</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-2-3" type="checkbox"/><label class="tocitem" for="menuitem-3-2-3"><span class="docs-label">Snow Modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Snow/base_tutorial/">Seasonal Snow Timeseries Generation with a Neural Network</a></li><li><a class="tocitem" href="../../Snow/data_tutorial/">Scraping SNOTEL Data</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox" checked/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">For model developers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../model_tutorial/">Intro to standalone models</a></li><li class="is-active"><a class="tocitem" href>Intro to multi-component models</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#The-individual-component-models-II-Surface-Water"><span>The individual component models II - Surface Water</span></a></li><li class="toplevel"><a class="tocitem" href="#An-LSM-with-pond-and-soil:"><span>An LSM with pond and soil:</span></a></li><li class="toplevel"><a class="tocitem" href="#Advantages-and-disadvantages"><span>Advantages and disadvantages</span></a></li></ul></li><li><a class="tocitem" href="../domain_tutorial/">Intro to ClimaLand Domains</a></li><li><a class="tocitem" href="../../../shared_utilities/driver_tutorial/">Intro to forced site-level runs</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Standalone models</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Vegetation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1-1"><span class="docs-label">Radiative transfer</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../standalone/pages/vegetation/radiative_transfer/beer_model/">Beer model</a></li><li><a class="tocitem" href="../../../../standalone/pages/vegetation/radiative_transfer/twostream_model/">Two-Stream model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-1-2" type="checkbox"/><label class="tocitem" for="menuitem-4-1-2"><span class="docs-label">Photosynthesis</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../standalone/pages/vegetation/photosynthesis/farquhar_model/">Farquhar model</a></li><li><a class="tocitem" href="../../../../standalone/pages/vegetation/photosynthesis/optimality_model/">Optimality model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-1-3" type="checkbox"/><label class="tocitem" for="menuitem-4-1-3"><span class="docs-label">Stomatal conductance</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../standalone/pages/vegetation/stomatal_conductance/medlyn_model/">Medlyn model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-1-4" type="checkbox"/><label class="tocitem" for="menuitem-4-1-4"><span class="docs-label">Plant hydraulics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../standalone/pages/vegetation/plant_hydraulics/van_genuchten_model/">Van Genuchten model</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Soil</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-2-1" type="checkbox"/><label class="tocitem" for="menuitem-4-2-1"><span class="docs-label">Biogeochemistry</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../standalone/pages/soil/biogeochemistry/DAMM_model/">DAMM model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2-2"><span class="docs-label">Hydrology</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../standalone/pages/soil/hydrology/richards_model/">Richards model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2-3" type="checkbox"/><label class="tocitem" for="menuitem-4-2-3"><span class="docs-label">Energy</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../standalone/pages/soil/energy/energy_model/">Energy model</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-3" type="checkbox"/><label class="tocitem" for="menuitem-4-3"><span class="docs-label">Snow</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../standalone/pages/snow/snow_model/">Snow model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-4" type="checkbox"/><label class="tocitem" for="menuitem-4-4"><span class="docs-label">SurfaceWater</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../standalone/pages/surface_water/surface_water_model/">Surface water model</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../diagnostics/users_diagnostics/">For users</a></li><li><a class="tocitem" href="../../../../diagnostics/developers_diagnostics/">For developers</a></li><li><a class="tocitem" href="../../../../diagnostics/available_diagnostics/">Available diagnostics</a></li></ul></li><li><a class="tocitem" href="../../../../Contributing/">Contribution guide</a></li><li><a class="tocitem" href="../../../../folderstructure/">Repository structure</a></li><li><input class="collapse-toggle" id="menuitem-8" type="checkbox"/><label class="tocitem" for="menuitem-8"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-8-1" type="checkbox"/><label class="tocitem" for="menuitem-8-1"><span class="docs-label">ClimaLand</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/ClimaLand/">ClimaLand</a></li><li><a class="tocitem" href="../../../../APIs/Regridder/">Parameter Dataset Tools</a></li><li><a class="tocitem" href="../../../../APIs/shared_utilities/">Shared Utilities</a></li><li><input class="collapse-toggle" id="menuitem-8-1-4" type="checkbox"/><label class="tocitem" for="menuitem-8-1-4"><span class="docs-label">Soil</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/Soil/">Soil Energy and Hydrology</a></li><li><a class="tocitem" href="../../../../APIs/SoilBiogeochemistry/">Soil Biogeochemistry</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-8-1-5" type="checkbox"/><label class="tocitem" for="menuitem-8-1-5"><span class="docs-label">Canopy</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../../APIs/canopy/Canopy/">Canopy Models</a></li><li><a class="tocitem" href="../../../../APIs/canopy/PlantHydraulics/">Plant Hydraulics</a></li><li><a class="tocitem" href="../../../../APIs/canopy/Photosynthesis/">Canopy Photosynthesis</a></li><li><a class="tocitem" href="../../../../APIs/canopy/RadiativeTransfer/">Canopy RT</a></li><li><a class="tocitem" href="../../../../APIs/canopy/CanopyEnergy/">Canopy Energy</a></li><li><a class="tocitem" href="../../../../APIs/canopy/StomatalConductance/">Canopy Stomatal Conductance</a></li><li><a class="tocitem" href="../../../../APIs/canopy/AutotrophicRespiration/">Canopy Autotrophic Respiration</a></li></ul></li><li><a class="tocitem" href="../../../../APIs/SurfaceWater/">Surface Water Models</a></li><li><a class="tocitem" href="../../../../APIs/Bucket/">Bucket Model</a></li><li><a class="tocitem" href="../../../../APIs/Snow/">Snow Model</a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li><a class="is-disabled">For model developers</a></li><li class="is-active"><a href>Intro to multi-component models</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Intro to multi-component models</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaLand.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaLand.jl/../../../../.." title="View source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><p>The <code>AbstractModel</code> <a href="https://clima.github.io/ClimaLand.jl/dev/generated/model_tutorial">tutorial</a> describes how a user can run simulations of a physical system governed by differential equations. In this framework, the user must define a model type for their problem, which contains all of the information required to set up the system of equations. By extending the methods for <code>make_compute_exp_tendency(model)</code>, <code>prognostic_variables(model)</code>, etc, the information stored in the <code>model</code> is used to make the system of equations. Given initial conditions, these equations can then be stepped forward in time using the time-stepper of your choice. Note that a model requiring implicit timestepping would instead use an <code>AbstractImExModel</code> framework.</p><p>The benefit of this framework is that it can be used for both individual components of an LSM (soil, snow, rivers, canopy biophysics, carbon...) <strong>as well as the LSM itself</strong>. Here we explain how a simple two component model can be set up using this software interface.</p><p>We&#39;ll first demonstrate how to set up two components in standalone mode, before spending time explaining the LSM setup. In our example, we have a component which accounts for soil hydrology via the Richardson-Richards (RR) equation.  Our second component is a surface water model without lateral flow (standing water, as in a pond). For more details on these models, and how they were set up, please feel free to look at the source code <a href="https://github.com/CliMA/ClimaLand.jl/blob/main/src/standalone/Soil/Soil.jl">here</a> and <a href="https://github.com/CliMA/ClimaLand.jl/blob/main/src/standalone/SurfaceWater/Pond.jl">here</a>. This tutorial focuses on using the <code>AbstractModel</code>s framework to set up the equations, rather than on running simulations.</p><p>First, let&#39;s load the required modules:</p><pre><code class="language-julia hljs">using ClimaLand
using ClimaLand.Domains: Column, obtain_surface_domain
using ClimaLand.Soil
using ClimaLand.Pond

FT = Float32;</code></pre><h1 id="The-individual-component-models-I-Soil-Hydrology"><a class="docs-heading-anchor" href="#The-individual-component-models-I-Soil-Hydrology">The individual component models I - Soil Hydrology</a><a id="The-individual-component-models-I-Soil-Hydrology-1"></a><a class="docs-heading-anchor-permalink" href="#The-individual-component-models-I-Soil-Hydrology" title="Permalink"></a></h1><p>The RR equation for the volumetric water content of soil is given by</p><p><span>$\frac{\partial ϑ}{\partial t} = -∇ ⋅ (-K∇(ψ+z)) + S(x,y,z, t)$</span></p><p>In order to solve this, one must specify:</p><ul><li>boundary conditions,</li><li>relevant parameters (closure models for <code>K</code> and <code>ψ</code>),</li><li>a domain and a spatial discretization scheme,</li><li>additional source terms <code>S</code>, if applicable,</li><li>a time-stepping algorithm,</li><li>initial conditions.</li></ul><p>We make the distinction between the spatially discretized equations (for which you need parameters, boundary conditions, source terms, and domain/ discretization scheme information in order to write down and evaluate), and the simulation you want to run (for which you need the equations, initial conditions, a time span, and a time-stepping scheme in order to specify completely).</p><p>Here, we&#39;ll focus on what you need to write the equations. This information is stored in the model structure itself, so that we can call <code>make_exp_tendency(model)</code> and get back a function which computes the time derivative of the prognostic variables, which the ODE timestepper needs to advance the state forward in time.</p><p>For the RR equation, we can create this as follows. First, we specify parameters:</p><pre><code class="language-julia hljs">ν = FT(0.495);
K_sat = FT(0.0443 / 3600 / 100); # m/s
S_s = FT(1e-3); #inverse meters
vg_n = FT(2.0);
vg_α = FT(2.6); # inverse meters
hcm = vanGenuchten{FT}(; α = vg_α, n = vg_n);
θ_r = FT(0);
soil_ps = Soil.RichardsParameters(;
    ν = ν,
    hydrology_cm = hcm,
    K_sat = K_sat,
    S_s = S_s,
    θ_r = θ_r,
);</code></pre><p>Next, let&#39;s define the spatial domain and discretization:</p><pre><code class="language-julia hljs">zmax = FT(0);
zmin = FT(-1);
nelems = 20;
soil_domain = Column(; zlim = (zmin, zmax), nelements = nelems);</code></pre><p>And boundary conditions and source terms (none currently):</p><pre><code class="language-julia hljs">top_flux_bc = WaterFluxBC((p, t) -&gt; 0.0);
bot_flux_bc = WaterFluxBC((p, t) -&gt; 0.0);
sources = ()
boundary_fluxes = (; top = top_flux_bc, bottom = bot_flux_bc)</code></pre><pre><code class="nohighlight hljs">(top = ClimaLand.Soil.WaterFluxBC{Main.var&quot;##502&quot;.var&quot;#1#2&quot;}(Main.var&quot;##502&quot;.var&quot;#1#2&quot;()), bottom = ClimaLand.Soil.WaterFluxBC{Main.var&quot;##502&quot;.var&quot;#3#4&quot;}(Main.var&quot;##502&quot;.var&quot;#3#4&quot;()))</code></pre><p>With this information, we can make our model:</p><pre><code class="language-julia hljs">soil = Soil.RichardsModel{FT}(;
    parameters = soil_ps,
    domain = soil_domain,
    boundary_conditions = boundary_fluxes,
    sources = sources,
);</code></pre><p>We also can create the soil prognostic and auxiliary <code>ClimaCore.Field.FieldVector</code>s using the default method for <code>initialize</code>,</p><pre><code class="language-julia hljs">Y_soil, p_soil, coords_soil = initialize(soil);</code></pre><p>and we can set up the tendency function using the default as well,</p><pre><code class="language-julia hljs">soil_ode! = make_exp_tendency(soil);</code></pre><p>which computes, for the column domain,</p><p><span>$-\frac{∂ }{∂z} (-K\frac{∂(ψ+z)}{∂ z})$</span></p><p>for each value of ϑ on the mesh of our <code>soil_domain</code>.</p><p>Note that the soil model does includes hydraulic <code>K</code>, pressure head <code>ψ</code>, and the boundary fluxes at the top and bottom of the domain in the auxiliary vector. These are updated first in each call to <code>soil_ode!</code>, as follows:</p><pre><code class="language-julia hljs">function soil_ode!(dY, Y, p, t)
         update_aux!(p,Y,t) # updates p.soil.K, p.soil.ψ in place
         update_boundary_fluxes!(p,Y,t) # updates p.soil.top_bc, p.soil.bottom_bc in place
         compute_exp_tendency!(dY, Y, p, t) # computes the divergence of the Darcy flux, updates dY in place.
end</code></pre><p>It is crucial the the cache <code>p</code> is correctly updated before the tendency is computed. The default method for <code>make_exp_tendency</code> creates the <code>update_aux!</code> and <code>update_boundary_fluxes!</code> functions, given the model, and evaluates them before computing the tendency, so we do not need to define that for the soil model.</p><p>Note also that we have defined methods <code>make_compute_exp_tendency</code>, <code>make_update_aux</code>, and <code>make_update_boundary_fluxes</code>, which only take the <code>model</code> as argument, and which return the functions <code>compute_exp_tendency!</code>, <code>update_aux!</code>, and <code>update_boundary_fluxes!</code>. Please see the API documentation or source code for more information.</p><p>Lastly, the coordinates returned by <code>initialize</code> contain the z-coordinates of the centers of the finite difference layers used for spatial discretization of the PDE.</p><h1 id="The-individual-component-models-II-Surface-Water"><a class="docs-heading-anchor" href="#The-individual-component-models-II-Surface-Water">The individual component models II - Surface Water</a><a id="The-individual-component-models-II-Surface-Water-1"></a><a class="docs-heading-anchor-permalink" href="#The-individual-component-models-II-Surface-Water" title="Permalink"></a></h1><p>The pond model has a single variable, the pond height η, which satisfies the ODE:</p><p><span>$\frac{∂ η}{∂ t} = -(P - I) = R,$</span></p><p>where P is the precipitation, I the infiltration into the soil, and R is the runoff. Note that P, I &lt; 0 indicates flow in the -ẑ direction.</p><p>To write down the pond equations, we need to specify</p><ul><li>P</li><li>I</li></ul><p>which are akin to boundary fluxes. In standalone mode,  one would need to pass in <strong>prescribed</strong> functions of time and store them inside our pond model, since again, the pond model structure must contain everything needed to make the tendency function:</p><pre><code class="language-julia hljs">precipitation(t) = t &lt; 20 ? -1e-5 : 0.0 # m/s

infiltration(t) = -(1e-6) #m/s
pond_model =
    Pond.PondModel{FT}(; runoff = PrescribedRunoff(precipitation, infiltration));</code></pre><p>Here, <code>PrescribedRunoff</code> is the structure holding the prescribed driving functions for <code>P</code> and <code>I</code>.</p><p>Again we can initialize the state vector and auxiliary vectors:</p><pre><code class="language-julia hljs">Y_pond, p_pond, coords_pond = initialize(pond_model);</code></pre><p>We can make the tendency function in the same way, for stepping the state forward in time:</p><pre><code class="language-julia hljs">pond_ode! = make_exp_tendency(pond_model);</code></pre><p>The <code>pond_ode!</code> function works in the same way as for the soil model:</p><pre><code class="language-julia hljs">function pond_ode!(dY, Y, p, t)
         update_aux!(p,Y,t) # falls back to default; does nothing
         update_boundary_fluxes!(p,Y,t)  # p.surface_water.runoff in place
         compute_exp_tendency!(dY, Y, p, t)
end</code></pre><h1 id="An-LSM-with-pond-and-soil:"><a class="docs-heading-anchor" href="#An-LSM-with-pond-and-soil:">An LSM with pond and soil:</a><a id="An-LSM-with-pond-and-soil:-1"></a><a class="docs-heading-anchor-permalink" href="#An-LSM-with-pond-and-soil:" title="Permalink"></a></h1><p>The LSM model must contain everything needed to write down the joint system of equations</p><p><span>$\frac{\partial \eta}{\partial t} = -(P(t) - I(ϑ, η, P)) = R,$</span></p><p><span>$\frac{\partial ϑ}{\partial t} = -∇ ⋅ (-K∇(ψ+z)) + S$</span></p><p><span>$-K ∇(ψ+z)|_{z = zmax}  ⋅ ẑ = I(ϑ, η, P)$</span></p><p><span>$-K ∇(ψ+z)|_{z = zmin}  ⋅ ẑ = 0.0.$</span></p><p>These two components interact via the infiltration term <code>I</code>. Infiltration is a boundary condition for the soil, and affects the source term for the surface water equation. Infiltration depends on precipitation, the soil moisture state, and the pond height.</p><p>As in the standalone cases, defining our model requires specifying</p><ul><li>parameters,</li><li>domains, discretizations</li><li>precipitation,</li><li>boundary conditions,</li><li>sources in the soil equation, if any.</li></ul><p>First, let&#39;s make our single column domain.</p><pre><code class="language-julia hljs">lsm_domain = Column(; zlim = (zmin, zmax), nelements = nelems);</code></pre><p>Let&#39;s now collect the needed arguments for the soil model. The pond model only has one argument, the runoff model, but that will be set internally. Similarily, the boundary conditions of the soil model will be set internally to be consisent with the equations of the pond-soil model - see below for detail.</p><pre><code class="language-julia hljs">soil_args = (parameters = soil_ps, domain = lsm_domain, sources = ());
surface_water_args = NamedTuple();</code></pre><p>Atmospheric drivers don&#39;t &quot;belong&quot; to either component alone:</p><pre><code class="language-julia hljs">land_args = (precip = precipitation,);
land = LandHydrology{FT}(;
    land_args = land_args,
    soil_model_type = Soil.RichardsModel{FT},
    soil_args = soil_args,
    surface_water_model_type = Pond.PondModel{FT},
    surface_water_args = surface_water_args,
);</code></pre><p>Here, <code>LandHydrology</code> is a type of <code>AbstractModel</code> which has a surface water model (Pond or otherwise) and a soil model (RR, or perhaps otherwise).</p><p>Now, note that we did not specify the infiltration function, like we did in standalone pond mode, nor did we specify boundary conditions for the soil model, nor did we specify the pond model domain. Yet, before we stressed that the model needs to have everything required to write down and evaluate the time derivative of the ODEs. So, how does this work?</p><p>Here, the LSM model <strong>constructor</strong> is given the information needed to make both the soil model and the pond model. Then, it is like running the pond and soil model in standalone mode, in series, <strong>except</strong> we have defined methods internally for computing the boundary condition and pond source term correctly, based on <code>I</code>, instead of using prescribed values passed in. The LSM constructor creates the correct <code>boundary_fluxes</code> object for the soil model, and the correct <code>infiltration</code> object for the pond model under the hood.</p><p>To advance the state of the joint system (ϑ, η) from time <code>t</code> to time <code>t+Δt</code>, we must compute the infiltration at <code>t</code>. This value is stored in <code>p.soil_infiltration</code>.  In pseudo code, we have:</p><pre><code class="language-julia hljs">function make_update_aux(land)
         soil_update_aux! = make_update_aux(land.soil)
         surface_update_aux! = make_update_aux(land.surface_water)
         function update_aux!(p,Y,t)
                  surface_update_aux!(p,Y,t) # does nothing to `p`
                  soil_update_aux!(p,Y,t) # updates p.soil.K and p.soil.ψ
         end
         return update_aux!
end</code></pre><pre><code class="language-julia hljs">function make_update_boundary_fluxes(land)
         update_soil_bf! = make_update_boundary_fluxes(land.soil)
         update_pond_bf! = make_update_boundary_fluxes(land.surface_water)
         function update_boundary_fluxes!(p,Y,t)
                  p.soil_infiltration = compute_infiltration(Y,p, t)
                  update_soil_bf!(p,Y,t) # updates p.soil.top_bc using p.soil_infiltration
                  update_pond_bf!(p,Y,t) # updates p.surface_water.runoff using p.soil_infiltration
         end
         return update_boundary_fluxes!
end</code></pre><p>and similarily for the <code>compute_exp_tendency!</code> functions:</p><pre><code class="language-julia hljs">function make_compute_exp_tendency(land)
         soil_compute_exp_tendency! = make_update_aux(land.soil)
         surface_compute_exp_tendency! = make_update_aux(land.surface_water)
         function compute_exp_tendency!(dY,Y,p,t)
                  surface_compute_exp_tendency!(dY,Y,p, t), # computes dY.surface.η
                  soil_compute_exp_tendency!(dY,Y,p,t) # computes dY.soil.ϑ
         end
         return compute_exp_tendency!
end</code></pre><p>The <code>exp_tendency!</code> for the land model is then again just</p><pre><code class="language-julia hljs">function exp_tendency!(dY, Y, p, t)
         update_aux!(p,Y,t)
         update_boundary_fluxes!(p,Y,t)
         compute_exp_tendency!(dY, Y, p, t)
end</code></pre><p>In the above, we showed explicitly what occurs by hardcoding the <code>compute_exp_tendency!</code>, <code>update_aux!</code> with names for <code>soil</code> and <code>surface_water</code>. In reality, this is done by looping over the components of the land model, meaning that we can use the same code internally for land models with different components.</p><p>A similar composition occurs for initializing the state itself: Calling <code>initialize(land)</code> does four things:</p><ul><li>initialize(land.soil)</li><li>initialize(land.surface_water)</li><li>initializes additional auxiliary variables, like p.soil_infiltration</li><li>append these into Y, p, and coords:</li></ul><pre><code class="language-julia hljs">Y, p, coords = initialize(land);</code></pre><p>We have volumetric liquid water fraction:</p><pre><code class="language-julia hljs">propertynames(Y.soil)</code></pre><pre><code class="nohighlight hljs">(:ϑ_l,)</code></pre><p>and surface height of the pond:</p><pre><code class="language-julia hljs">propertynames(Y.surface_water)</code></pre><pre><code class="nohighlight hljs">(:η,)</code></pre><p>as well as auxiliary variables for the soil:</p><pre><code class="language-julia hljs">propertynames(p.soil)</code></pre><pre><code class="nohighlight hljs">(:K, :ψ, :top_bc, :bottom_bc)</code></pre><p>and the runoff for surface water:</p><pre><code class="language-julia hljs">propertynames(p.surface_water)</code></pre><pre><code class="nohighlight hljs">(:runoff,)</code></pre><p>and the additional variable required in the LSM is stored here as well:</p><pre><code class="language-julia hljs">propertynames(p)</code></pre><pre><code class="nohighlight hljs">(:soil_infiltration, :soil, :surface_water)</code></pre><p>and finally, coordinates - useful for visualization of solutions:</p><pre><code class="language-julia hljs">coords.subsurface</code></pre><pre><code class="nohighlight hljs">ClimaCore.Geometry.ZPoint{Float32}-valued Field:
  z: Float32[-0.975, -0.925, -0.875, -0.825, -0.775, -0.725, -0.675, -0.625, -0.575, -0.525, -0.475, -0.425, -0.375, -0.325, -0.275, -0.225, -0.175, -0.125, -0.075, -0.025]</code></pre><p>and the coordinates of the surface variables:</p><pre><code class="language-julia hljs">coords.surface</code></pre><pre><code class="nohighlight hljs">ClimaCore.Geometry.ZPoint{Float32}-valued Field:
  z: Float32[0.0]</code></pre><p>And we can make the tendency function as before:</p><pre><code class="language-julia hljs">land_ode! = make_exp_tendency(land);</code></pre><p>Next up would be to set initial conditions, choose a timestepping scheme, and run your simulation.</p><h1 id="Advantages-and-disadvantages"><a class="docs-heading-anchor" href="#Advantages-and-disadvantages">Advantages and disadvantages</a><a id="Advantages-and-disadvantages-1"></a><a class="docs-heading-anchor-permalink" href="#Advantages-and-disadvantages" title="Permalink"></a></h1><p>Some advantages to our interface design are as follows:</p><ul><li>a developer only needs to learn a few concepts (<code>compute_exp_tendency!</code>, prognostic vs. aux variables, <code>update_aux!</code>/<code>update_boundary_fluxes!</code>, <code>initialize</code>, domains) to make a model which can be run in standalone or work with other components.</li><li>likewise, a user only needs to learn one interface to run all models, regardless of if they are standalone components or LSMs with multiple components.</li><li>the <code>exp_tendency!</code>is completely seperate from the timestepping scheme used, so any scheme can be used (with the exception of mixed implicit/explicit schemes, which we can&#39;t handle yet).</li><li>although we wrote it here in a <span>$hardwired$</span> fashion for surface water and soil, the <code>update_aux!</code>, <code>compute_exp_tendency!</code> methods for LSM models generalize to any number and mix of components. One just needs to write a new model type (e.g. <code>BiophysicsModel &lt;: AbstractModel</code> for a vegetation and carbon component model) and the appropriate <code>make_update_boundary_var</code> methods for that model.</li><li>the order in which the components are treated in the tendency or in update aux does not matter. What matters is that (1) auxiliary/cache variables are updated prior to calling <code>update_boundary_fluxes!</code>, and that (2) <code>update_boundary_fluxes!</code> is called prior to evaluating the tendency.</li><li>the code is also modular in terms of swapping out a simple component model for a more complex version.</li></ul><p>Possible disadvantages to our interface design:</p><ul><li>Even in standalone model, variables are accessed in a nested way: Y.soil, p.soil, etc, which is excessive.</li><li>To accomodate the fact that some components involve PDEs, a developer for purely ODE based component does need to at least handle <code>ClimaCore.Field.FieldVector</code>s.</li><li>standalone models need to play by the rules of <code>AbstractModel</code>s, and LSMs need to play by the rules of <code>ClimaLand.jl</code>.</li><li>we need to define multiple update cache functions in order to handle dependencies between cache variables of one component model and boundary fluxes of another.</li></ul><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../model_tutorial/">« Intro to standalone models</a><a class="docs-footer-nextpage" href="../domain_tutorial/">Intro to ClimaLand Domains »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Friday 4 October 2024 23:57">Friday 4 October 2024</span>. Using Julia version 1.10.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
