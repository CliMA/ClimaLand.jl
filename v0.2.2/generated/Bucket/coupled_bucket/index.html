<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Setting up a Coupled Simulation · ClimaLSM.jl</title><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">ClimaLSM.jl</a></span></div><form class="docs-search" action="../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-2-1" type="checkbox"/><label class="tocitem" for="menuitem-2-1"><span class="docs-label">ClimaLSM</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/ClimaLSM/">ClimaLSM</a></li><li><a class="tocitem" href="../../../APIs/Regridder/">Parameter Dataset Tools</a></li><li><a class="tocitem" href="../../../APIs/SharedUtilities/">Shared Utilities</a></li><li><a class="tocitem" href="../../../APIs/Soil/">Soil Energy and Hydrology</a></li><li><a class="tocitem" href="../../../APIs/SoilBiogeochemistry/">Soil Biogeochemistry</a></li><li><a class="tocitem" href="../../../APIs/Vegetation/">Vegetation Models</a></li><li><a class="tocitem" href="../../../APIs/SurfaceWater/">Surface Water Models</a></li><li><a class="tocitem" href="../../../APIs/Bucket/">Bucket Model</a></li></ul></li></ul></li><li><a class="tocitem" href="../../../Contributing/">Contribution guide</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">For model developers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Usage/model_tutorial/">Using AbstractModel functionality</a></li><li><a class="tocitem" href="../../Usage/LSM_single_column_tutorial/">Intro to multi-component models</a></li><li><a class="tocitem" href="../../Usage/domain_tutorial/">Intro to ClimaLSM Domains</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox" checked/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Running simulations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-2-1" type="checkbox"/><label class="tocitem" for="menuitem-4-2-1"><span class="docs-label">Soil modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Soil/richards_equation/">Richards Equation</a></li><li><a class="tocitem" href="../../Soil/soil_energy_hydrology/">Energy and Hydrology</a></li><li><a class="tocitem" href="../../Soil/freezing_front/">Phase Changes</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2-2" type="checkbox" checked/><label class="tocitem" for="menuitem-4-2-2"><span class="docs-label">Bucket LSM</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../bucket_tutorial/">Introduction to the Land Bucket Model</a></li><li class="is-active"><a class="tocitem" href>Setting up a Coupled Simulation</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Background"><span>Background</span></a></li><li class="toplevel"><a class="tocitem" href="#Turbulent-Surface-Fluxes-and-Radiation"><span>Turbulent Surface Fluxes and Radiation</span></a></li><li class="toplevel"><a class="tocitem" href="#Precipitation-and-surface-air-density"><span>Precipitation and surface air density</span></a></li></ul></li></ul></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li><a class="is-disabled">Running simulations</a></li><li><a class="is-disabled">Bucket LSM</a></li><li class="is-active"><a href>Setting up a Coupled Simulation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Setting up a Coupled Simulation</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/ClimaLSM.jl/../../../.." title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Setting-up-a-Coupled-Simulation"><a class="docs-heading-anchor" href="#Setting-up-a-Coupled-Simulation">Setting up a Coupled Simulation</a><a id="Setting-up-a-Coupled-Simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Setting-up-a-Coupled-Simulation" title="Permalink"></a></h1><p>For more information about the bucket model, please see <a href="https://clima.github.io/ClimaLSM.jl/dev/generated/bucket_tutorial/">the bucket model tutorial</a>.</p><p>This tutorial shows how to set up a simulation for a coupled simulation. More detail for coupled runs can be found in the ClimaCoupler.jl <a href="https://clima.github.io/ClimaCoupler.jl/dev/">documentation</a>. In preparation for understanding this tutorial, we recommend also reading the <a href="https://clima.github.io/ClimaLSM.jl/dev/generated/LSM_single_column_tutorial/">intro to multi-component models tutorial</a> as well as being familiar with multiple dispatch programming in Julia.</p><h1 id="Background"><a class="docs-heading-anchor" href="#Background">Background</a><a id="Background-1"></a><a class="docs-heading-anchor-permalink" href="#Background" title="Permalink"></a></h1><p>Recall that in order to drive the system in standalone mode, the user must provide prescribed functions of time for the water volume flux in precipitation,  for the net downward shortwave and longwave radiative energy fluxes, for the atmospheric temperature <code>T_a</code>, wind speed <code>u_a</code> (m/s), specific humidity <code>q_a</code>, and air density <code>ρ_a</code> (kg/m^3) at a reference height <code>h_a</code> (m), as well as for the air density <code>ρ_sfc</code> (kg/m^3) at the surface of the earth.</p><p>Turbulent surface fluxes are computed by the bucket model at each step of the simulation, using the land surface properties as well as the prescribed atmospheric properties, according to Monin-Obukhov theory. These fluxes, as well as the net radiation, are stored in the <code>auxiliary</code> state of the bucket model: <code>p.bucket.turbulent_energy_flux</code>, <code>p.bucket.evaporation</code>, <code>p.bucket.R_n</code>, where they are accessible when boundary conditions are required in the ODE functions (right hand side) of the prognostic equations.</p><p>In a coupled simulation, this changes. As we will see, the coupler computes turbulent surface fluxes based on information (prognostic state, parameters) passed to it by both the atmosphere and land models. Net radiation is computed within the atmosphere model, using the prognostic land surface temperature and the land surface albedo, and passed back to the land model via the coupler. Similarily, precipitation is computed within the atmosphere model, and passed back to the land model via the coupler. These details are important, but from the point of view of the land model, we only need to know that the coupler accesses land model variables to compute fluxes, and that the coupler passes these fluxes back to the land model.</p><p>In our current setup, &quot;passed back to the land model via the coupler&quot; means that the coupler accesses the auxiliary state of the land model and modifies it, at each step in the simulation, so that it holds the current net radiation, precipitation, and turbulent surface fluxes (<code>p.bucket.turbulent_energy_flux</code>, <code>p.bucket.evaporation</code>, <code>p.bucket.R_n</code>, <code>p.bucket.P_liq</code>, <code>p.bucket.P_snow</code>). These quantities are then still available in the ODE functions of the prognostic equations for the bucket model, as in the standalone case.</p><p>In order for the land model to be able to run both in standalone mode, and a coupled mode, within a single interface, we make use of multiple dispatch.</p><p>To begin, let&#39;s import some necessary abstract and concrete types, as well as methods.</p><pre><code class="language-julia hljs">using ClimaLSM
using ClimaLSM.Bucket:
    BucketModel,
    BucketModelParameters,
    AbstractAtmosphericDrivers,
    AbstractRadiativeDrivers

import ClimaLSM.Bucket:
    surface_fluxes,
    surface_air_density,
    liquid_precipitation,
    snow_precipitation

FT = Float64;</code></pre><h1 id="Turbulent-Surface-Fluxes-and-Radiation"><a class="docs-heading-anchor" href="#Turbulent-Surface-Fluxes-and-Radiation">Turbulent Surface Fluxes and Radiation</a><a id="Turbulent-Surface-Fluxes-and-Radiation-1"></a><a class="docs-heading-anchor-permalink" href="#Turbulent-Surface-Fluxes-and-Radiation" title="Permalink"></a></h1><p>Let&#39;s review how turbulent surface fluxes and radiation are computed by the land model. The user first creates the prescribed atmosphere and prescribed radiation drivers. In pseudo code, this might look something like:</p><p><code>prescribed_atmos = PrescribedAtmosphere{FT}(*driver functions passed in here*)</code> <code>prescribed_radiation = PrescribedRadiativeFluxes{FT}(*driver functions passed in here*)</code></p><p>These are stored in the <a href="https://clima.github.io/ClimaLSM.jl/dev/APIs/Bucket/#ClimaLSM.Bucket.BucketModel">BucketModel</a> object, along with <a href="https://clima.github.io/ClimaLSM.jl/dev/APIs/Bucket/#ClimaLSM.Bucket.BucketParameters">BucketParameters</a>. In order to compute turbulent surface fluxes, we call <a href="https://clima.github.io/ClimaLSM.jl/dev/APIs/Bucket/#ClimaLSM.Bucket.surface_fluxes">surface_fluxes</a>, with arguments including <code>prescribed_atmosphere</code>. Since this argument is of the type <code>PrescribedAtmosphere</code>, the method of <code>surface_fluxes</code> which is executed is one which computes the turbulent surface fluxes using MOST. We have a similar function for <a href="https://clima.github.io/ClimaLSM.jl/dev/APIs/Bucket/#ClimaLSM.Bucket.net_radiation">net_radiation</a> and which computes the net radiation based on the prescribed downwelling radiative fluxes, stored in an argument <code>prescribed_radiation</code>, which is of type <code>PrescribedRadiation</code>.</p><p>In the coupled case, we want different behavior. Inside coupler source code, we define new <span>$coupled$</span> types to use instead of the &quot;prescribed&quot; types:</p><pre><code class="language-julia hljs">struct CoupledAtmosphere{FT} &lt;: AbstractAtmosphericDrivers{FT} end
struct CoupledRadiativeFluxes{FT} &lt;: AbstractRadiativeDrivers{FT} end</code></pre><p>Then, we define a new method for <code>surface_fluxes</code> and <code>net_radiation</code> which dispatch for these types:</p><pre><code class="language-julia hljs">function ClimaLSM.Bucket.surface_fluxes(
    Y,
    p,
    t,
    parameters,
    atmos::CoupledAtmosphere{FT},
) where {FT &lt;: AbstractFloat}
    return (
        turbulent_energy_flux = p.bucket.turbulent_energy_flux,
        evaporation = p.bucket.evaporation,
    )
end


function ClimaLSM.Bucket.net_radiation(
    Y,
    p,
    t,
    parameters,
    radiation::CoupledRadiativeFluxes{FT},
) where {FT &lt;: AbstractFloat}
    return p.bucket.R_n
end</code></pre><p>Essentially, these methods simply returns the values stored in the auxiliary state <code>p</code>. Importantly, these functions are called by the bucket model each time step <strong>after</strong> the coupler has already computed these values (or extracted them from another model) and modifed <code>p</code>!</p><h1 id="Precipitation-and-surface-air-density"><a class="docs-heading-anchor" href="#Precipitation-and-surface-air-density">Precipitation and surface air density</a><a id="Precipitation-and-surface-air-density-1"></a><a class="docs-heading-anchor-permalink" href="#Precipitation-and-surface-air-density" title="Permalink"></a></h1><p>Within the right hand side/ODE function calls for the bucket model, we need both the liquid/snow precipitation and the surface air density (for computing specific humidity at the surface). In standalone runs, we call the functions <a href="https://clima.github.io/ClimaLSM.jl/dev/APIs/Bucket/#ClimaLSM.Bucket.surface_air_density"><code>surface_air_density</code></a>,  <a href="https://clima.github.io/ClimaLSM.jl/dev/APIs/Bucket/#ClimaLSM.Bucket.liquid_precipitation"><code>liquid_precipitation</code></a>, and <a href="https://clima.github.io/ClimaLSM.jl/dev/APIs/Bucket/#ClimaLSM.Bucket.snow_precipitation"><code>snow_precipitation</code></a>. When the <code>atmos</code> type is <code>PrescribedAtmosphere</code>, these return the prescribed values for these quantities.</p><p>In the coupled case, we need to extend these functions with a <code>CoupledAtmosphere</code> method:</p><pre><code class="language-julia hljs">function ClimaLSM.Bucket.surface_air_density(p, atmos::CoupledAtmosphere)
    return p.bucket.ρ_sfc
end

function ClimaLSM.Bucket.liquid_precipitation(p, atmos::CoupledAtmosphere, t)
    return p.bucket.P_liq
end

function ClimaLSM.Bucket.snow_precipitation(p, atmos::CoupledAtmosphere, t)
    return p.bucket.P_snow
end</code></pre><p>Again, these functions are called in the ODE function of the bucket model <em>after</em> the coupler has updated the values of <code>p</code> with the correct values at that timestep.</p><p>Two other notes: (1) the coupler code actually extends the auxiliary state <code>p</code> of the bucket model, adding in the fields <code>P_liq</code>, <code>P_snow</code>, and <code>ρ_sfc</code>. These fields do not exist in <code>p</code> if the standalone bucket model, and (2) the surface air density is computed assuming an ideal gas and hydrostatic balance and by extrapolating from the air density at the lowest level of the atmosphere, which is why it is handled by the coupler.</p><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../bucket_tutorial/">« Introduction to the Land Bucket Model</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Friday 20 January 2023 00:36">Friday 20 January 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
