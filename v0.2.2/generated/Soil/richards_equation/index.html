<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Richards Equation · ClimaLSM.jl</title><script data-outdated-warner src="../../../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="../../.."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../../../assets/documenter.js"></script><script src="../../../siteinfo.js"></script><script src="../../../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../../../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../../../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../../../">ClimaLSM.jl</a></span></div><form class="docs-search" action="../../../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../../../">Home</a></li><li><input class="collapse-toggle" id="menuitem-2" type="checkbox"/><label class="tocitem" for="menuitem-2"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-2-1" type="checkbox"/><label class="tocitem" for="menuitem-2-1"><span class="docs-label">ClimaLSM</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../../APIs/ClimaLSM/">ClimaLSM</a></li><li><a class="tocitem" href="../../../APIs/Regridder/">Parameter Dataset Tools</a></li><li><a class="tocitem" href="../../../APIs/SharedUtilities/">Shared Utilities</a></li><li><a class="tocitem" href="../../../APIs/Soil/">Soil Energy and Hydrology</a></li><li><a class="tocitem" href="../../../APIs/SoilBiogeochemistry/">Soil Biogeochemistry</a></li><li><a class="tocitem" href="../../../APIs/Vegetation/">Vegetation Models</a></li><li><a class="tocitem" href="../../../APIs/SurfaceWater/">Surface Water Models</a></li><li><a class="tocitem" href="../../../APIs/Bucket/">Bucket Model</a></li></ul></li></ul></li><li><a class="tocitem" href="../../../Contributing/">Contribution guide</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox" checked/><label class="tocitem" for="menuitem-4"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">For model developers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Usage/model_tutorial/">Using AbstractModel functionality</a></li><li><a class="tocitem" href="../../Usage/LSM_single_column_tutorial/">Intro to multi-component models</a></li><li><a class="tocitem" href="../../Usage/domain_tutorial/">Intro to ClimaLSM Domains</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox" checked/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Running simulations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-2-1" type="checkbox" checked/><label class="tocitem" for="menuitem-4-2-1"><span class="docs-label">Soil modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li class="is-active"><a class="tocitem" href>Richards Equation</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Preliminary-setup"><span>Preliminary setup</span></a></li><li class="toplevel"><a class="tocitem" href="#Set-up-the-soil-model"><span>Set up the soil model</span></a></li><li class="toplevel"><a class="tocitem" href="#Set-up-the-simulation"><span>Set up the simulation</span></a></li><li class="toplevel"><a class="tocitem" href="#Create-some-plots"><span>Create some plots</span></a></li><li class="toplevel"><a class="tocitem" href="#References"><span>References</span></a></li></ul></li><li><a class="tocitem" href="../soil_energy_hydrology/">Energy and Hydrology</a></li><li><a class="tocitem" href="../freezing_front/">Phase Changes</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2-2"><span class="docs-label">Bucket LSM</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../../Bucket/bucket_tutorial/">Introduction to the Land Bucket Model</a></li><li><a class="tocitem" href="../../Bucket/coupled_bucket/">Setting up a Coupled Simulation</a></li></ul></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li><a class="is-disabled">Running simulations</a></li><li><a class="is-disabled">Soil modeling</a></li><li class="is-active"><a href>Richards Equation</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Richards Equation</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/CliMA/ClimaLSM.jl/../../../.." title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Hydrostatic-Equilibrium-test-for-Richards-Equation"><a class="docs-heading-anchor" href="#Hydrostatic-Equilibrium-test-for-Richards-Equation">Hydrostatic Equilibrium test for Richards Equation</a><a id="Hydrostatic-Equilibrium-test-for-Richards-Equation-1"></a><a class="docs-heading-anchor-permalink" href="#Hydrostatic-Equilibrium-test-for-Richards-Equation" title="Permalink"></a></h1><p>This tutorial shows how to use <code>ClimaLSM</code> code to solve Richards equation in a column of soil. We choose boundary conditions of zero flux at the top and bottom of the column, and then run the simulation long enough to see that the system is approaching hydrostatic equilibrium, where the gradient of the pressure head is equal and opposite the gradient of the gravitational head.</p><p>The equations are:</p><p><span>$\frac{ ∂ ϑ_l}{∂ t} = ∇ ⋅ K (ϑ_l; ν, ...) ∇h( ϑ_l, z; ν, ...).$</span></p><p>Here</p><p><span>$t$</span> is the time (s),</p><p><span>$z$</span> is the location in the vertical (m),</p><p><span>$K$</span> is the hydraulic conductivity (m/s),</p><p><span>$h$</span> is the hydraulic head (m),</p><p><span>$ϑ_l$</span> is the augmented volumetric liquid water fraction,</p><p><span>$ν, ...$</span> denotes parameters relating to soil type, such as porosity.</p><p>We will solve this equation in a 1-d domain with <span>$z ∈ [-5,0]$</span>, and with the following boundary and initial conditions:</p><p><span>$- K ∇h(t, z = 0) = 0 ẑ$</span></p><p><span>$-K ∇h(t, z = -5) = 0 ẑ$</span></p><p><span>$ϑ(t = 0, z) = ν-0.001$</span></p><p><span>$θ_i(t = 0, z) = 0.0.$</span></p><p>where <span>$\nu$</span> is the porosity.</p><p>When solving Richards equation (not a fully integrated energy and hydrology model), the hydraulic conductivity is only a function of liquid moisture content.</p><p>Lastly, our formulation of this equation allows for a continuous solution in both saturated and unsaturated areas, following Woodward and Dawson (2000).</p><h1 id="Preliminary-setup"><a class="docs-heading-anchor" href="#Preliminary-setup">Preliminary setup</a><a id="Preliminary-setup-1"></a><a class="docs-heading-anchor-permalink" href="#Preliminary-setup" title="Permalink"></a></h1><ul><li>Load external packages</li></ul><pre><code class="language-julia hljs">using OrdinaryDiffEq: ODEProblem, solve, RK4
using Plots</code></pre><ul><li>Load CLIMAParameters and ClimaLSM modules</li></ul><pre><code class="language-julia hljs">using ClimaCore
import CLIMAParameters as CP

if !(&quot;.&quot; in LOAD_PATH)
    push!(LOAD_PATH, &quot;.&quot;)
end
using ClimaLSM
using ClimaLSM.Domains: Column
using ClimaLSM.Soil

import ClimaLSM
import ClimaLSM.Parameters as LSMP
include(joinpath(pkgdir(ClimaLSM), &quot;parameters&quot;, &quot;create_parameters.jl&quot;));</code></pre><ul><li>Define the float type desired (<code>Float64</code> or <code>Float32</code>), and get the parameter set, which holds constants used across CliMA models:</li></ul><pre><code class="language-julia hljs">const FT = Float64;
earth_param_set = create_lsm_parameters(FT);</code></pre><h1 id="Set-up-the-soil-model"><a class="docs-heading-anchor" href="#Set-up-the-soil-model">Set up the soil model</a><a id="Set-up-the-soil-model-1"></a><a class="docs-heading-anchor-permalink" href="#Set-up-the-soil-model" title="Permalink"></a></h1><p>We want to solve Richards equation alone, without simultaneously solving the heat equation. Because of that, we choose a <a href="../../../APIs/Soil/#ClimaLSM.Soil.RichardsModel"><code>RichardsModel</code></a>. Taking a look at the documentation (linked), we see that we need to supply parameters, a domain, boundary conditions, and sources.</p><p>First, we define the parameters: porosity <code>\nu</code>, Ksat, the van Genuchten parameters <code>vg_α</code>, <code>vg_m</code>, <code>vg_n</code>, <code>θ_r</code>, and the specific storage value for the soil. Note that all values must be given in mks units.</p><pre><code class="language-julia hljs">Ksat = FT(0.0443 / (3600 * 100))
S_s = FT(1e-3)
ν = FT(0.495)
vg_α = FT(2.6)
vg_n = FT(2)
vg_m = 1 - 1 / vg_n
θ_r = FT(0)
params = Soil.RichardsParameters{FT}(ν, vg_α, vg_n, vg_m, Ksat, S_s, θ_r);</code></pre><p>Next, we define the domain. Here, we are considering a 1D domain, discretized using finite difference, with coordinates <code>z</code>:</p><pre><code class="language-julia hljs">zmax = FT(0)
zmin = FT(-5)
nelems = 10
soil_domain = Column(; zlim = (zmin, zmax), nelements = nelems);</code></pre><p>We also need to specify the boundary conditions. The user can specify two conditions, either at the top or at the bottom, and they can either be either on the state <code>ϑ_l</code> or on the flux  <code>-K∇h</code>. Flux boundary conditions are passed as the (scalar) z-component of the flux <code>f</code>, i.e. F⃗ = f ẑ. In either case, the user must pass a function of the auxiliary variables <code>p</code> and time <code>t</code>:</p><pre><code class="language-julia hljs">surface_flux = Soil.FluxBC((p, t) -&gt; eltype(t)(0.0))
bottom_flux = Soil.FluxBC((p, t) -&gt; eltype(t)(0.0))
boundary_conditions = (; water = (top = surface_flux, bottom = bottom_flux));</code></pre><p>Lastly, in this case we don&#39;t have any sources, so we pass an empty tuple:</p><pre><code class="language-julia hljs">sources = ();</code></pre><p>Now we can make the model itself. This contains every piece of information needed to turn the continuous form of Richards equation into a set of ODEs, ready to be passed off to a timestepper.</p><pre><code class="language-julia hljs">soil = Soil.RichardsModel{FT}(;
    parameters = params,
    domain = soil_domain,
    boundary_conditions = boundary_conditions,
    sources = sources,
);
soil_ode! = make_ode_function(soil);</code></pre><h1 id="Set-up-the-simulation"><a class="docs-heading-anchor" href="#Set-up-the-simulation">Set up the simulation</a><a id="Set-up-the-simulation-1"></a><a class="docs-heading-anchor-permalink" href="#Set-up-the-simulation" title="Permalink"></a></h1><p>We can now initialize the prognostic and auxiliary variable vectors, and take a peek at what those variables are:</p><pre><code class="language-julia hljs">Y, p, coords = initialize(soil);
Y.soil |&gt; propertynames

p.soil |&gt; propertynames

coords |&gt; propertynames</code></pre><pre><code class="nohighlight hljs">(:z,)</code></pre><p>Note that the variables are nested into <code>Y</code> and <code>p</code> in a hierarchical way. Since we have the vectors (composed of <a href="https://clima.github.io/ClimaCore.jl/dev/api/#ClimaCore.Fields.Field">ClimaCore Fields</a> handy, we can now set them to the desired initial conditions.</p><pre><code class="language-julia hljs">Y.soil.ϑ_l .= FT(0.494);</code></pre><p>Next, we turn to timestepping. We choose the initial and final times, as well as a timestep.</p><pre><code class="language-julia hljs">t0 = FT(0)
timeend = FT(60 * 60 * 24 * 36)
dt = FT(100);</code></pre><p>And then we can solve the system of equations, using <a href="https://github.com/SciML/OrdinaryDiffEq.jl">OrdinaryDiffEq.jl</a>:</p><pre><code class="language-julia hljs">prob = ODEProblem(soil_ode!, Y, (t0, timeend), p)
sol = solve(prob, RK4(); dt = dt, adaptive = false);</code></pre><h1 id="Create-some-plots"><a class="docs-heading-anchor" href="#Create-some-plots">Create some plots</a><a id="Create-some-plots-1"></a><a class="docs-heading-anchor-permalink" href="#Create-some-plots" title="Permalink"></a></h1><p>We&#39;ll plot the moisture content vs depth in the soil, as well as the expected profile of <code>ϑ_l</code> in hydrostatic equilibrium. For <code>ϑ_l</code> values above porosity, the soil is saturated, and the pressure head changes from being equal to the matric potential to the pressure generated by compression of water and the soil matrix. The profile can be solved for analytically by (1) solving for the form that <code>ϑ_l(z)</code> must take in both the saturated and unsaturated zones to satisfy the steady-state requirement with zero flux boundary conditions, (2) requiring that at the interface between saturated and unsaturated zones, the water content equals porosity, and (3) solving for the location of the interface by requiring that the integrated water content at the end matches that at the beginning (yielding an interface location of <code>z≈-0.56m</code>).</p><pre><code class="language-julia hljs">t = sol.t ./ (60 * 60 * 24);
ϑ_l = [parent(sol.u[k].soil.ϑ_l) for k in 1:length(t)]
z = parent(coords.z)
plot(
    ϑ_l[1],
    z,
    label = string(&quot;t = &quot;, string(t[1]), &quot;days&quot;),
    xlim = [0.47, 0.501],
    ylabel = &quot;z&quot;,
    xlabel = &quot;ϑ_l&quot;,
    legend = :bottomleft,
    title = &quot;Equilibrium test&quot;,
);
plot!(ϑ_l[end], z, label = string(&quot;t = &quot;, string(t[end]), &quot;days&quot;));
function hydrostatic_equilibrium(z, z_interface)
    ν = 0.495
    S_s = 1e-3
    α = 2.6
    n = 2.0
    m = 0.5
    if z &lt; z_interface
        return -S_s * (z - z_interface) + ν
    else
        return ν * (1 + (α * (z - z_interface))^n)^(-m)
    end
end
plot!(hydrostatic_equilibrium.(z, -0.56), z, label = &quot;equilibrium solution&quot;);

plot!(1e-3 .+ ϑ_l[1], z, label = &quot;porosity&quot;);</code></pre><p>Save the output:</p><pre><code class="language-julia hljs">savefig(&quot;equilibrium_test_ϑ_l.png&quot;);</code></pre><p><img src="../equilibrium_test_ϑ_l.png" alt/></p><h1 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h1><ul><li>Woodward and Dawson, (2000) SIAM J. Numer. Anal., 37, 701–724</li></ul><hr/><p><em>This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.</em></p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../../Usage/domain_tutorial/">« Intro to ClimaLSM Domains</a><a class="docs-footer-nextpage" href="../soil_energy_hydrology/">Energy and Hydrology »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Friday 20 January 2023 00:36">Friday 20 January 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
