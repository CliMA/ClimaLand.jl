<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Calibration · ClimaLand.jl</title><meta name="title" content="Calibration · ClimaLand.jl"/><meta property="og:title" content="Calibration · ClimaLand.jl"/><meta property="twitter:title" content="Calibration · ClimaLand.jl"/><meta name="description" content="Documentation for ClimaLand.jl."/><meta property="og:description" content="Documentation for ClimaLand.jl."/><meta property="twitter:description" content="Documentation for ClimaLand.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="ClimaLand.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaLand.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../getting_started/">Running your first simulation</a></li><li><input class="collapse-toggle" id="menuitem-3" type="checkbox"/><label class="tocitem" for="menuitem-3"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-3-1" type="checkbox"/><label class="tocitem" for="menuitem-3-1"><span class="docs-label">Running standalone component simulations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/standalone/Bucket/bucket_tutorial/">Bucket</a></li><li><input class="collapse-toggle" id="menuitem-3-1-2" type="checkbox"/><label class="tocitem" for="menuitem-3-1-2"><span class="docs-label">Soil</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/standalone/Soil/boundary_conditions/">Boundary conditions</a></li><li><a class="tocitem" href="../generated/standalone/Soil/richards_equation/">Richards Equation</a></li><li><a class="tocitem" href="../generated/standalone/Soil/soil_energy_hydrology/">Energy and Hydrology</a></li><li><input class="collapse-toggle" id="menuitem-3-1-2-4" type="checkbox"/><label class="tocitem" for="menuitem-3-1-2-4"><span class="docs-label">Phase Changes</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/standalone/Soil/freezing_front/">Modeling a freezing front in unsaturated soil</a></li><li><a class="tocitem" href="../generated/standalone/Soil/phase_change_analytic/">The Stefan problem</a></li></ul></li><li><a class="tocitem" href="../generated/standalone/Soil/layered_soil/">Layered Soil</a></li><li><a class="tocitem" href="../generated/standalone/Soil/evaporation/">Coarse Sand Evaporation</a></li><li><a class="tocitem" href="../generated/standalone/Soil/evaporation_gilat_loess/">Gilat Loess Evaporation</a></li><li><a class="tocitem" href="../generated/standalone/Soil/sublimation/">Bare soil site</a></li><li><a class="tocitem" href="../generated/standalone/Soil/changing_soil_parameterizations/">Changing soil parameterizations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-1-3" type="checkbox"/><label class="tocitem" for="menuitem-3-1-3"><span class="docs-label">Canopy</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/standalone/Canopy/default_canopy/">Default canopy</a></li><li><a class="tocitem" href="../generated/standalone/Canopy/canopy_tutorial/">Default canopy fluxtower simulation </a></li><li><a class="tocitem" href="../generated/standalone/Canopy/changing_canopy_parameterizations/">Changing canopy parameterizations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-1-4" type="checkbox"/><label class="tocitem" for="menuitem-3-1-4"><span class="docs-label">Snow</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/standalone/Snow/base_tutorial/">Base tutorial</a></li><li><a class="tocitem" href="../generated/standalone/Snow/data_tutorial/">Data tutorial</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-2" type="checkbox"/><label class="tocitem" for="menuitem-3-2"><span class="docs-label">Running Fluxnet simulations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/integrated/soil_canopy_fluxnet_tutorial/">Canopy and soil</a></li><li><a class="tocitem" href="../generated/integrated/snowy_land_fluxnet_tutorial/">Canopy, soil, and snow</a></li><li><a class="tocitem" href="../generated/integrated/changing_snowy_land_parameterizations/">Changing LandModel parameterizations</a></li><li><a class="tocitem" href="../generated/integrated/fluxnet_data/">Data processing</a></li><li><a class="tocitem" href="../generated/integrated/fluxnet_vis/">Visualization</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-3" type="checkbox"/><label class="tocitem" for="menuitem-3-3"><span class="docs-label">Running global simulations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/global/bucket/">Bucket</a></li><li><a class="tocitem" href="../generated/global/snowy_land/">Snow, soil, canopy</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-4" type="checkbox"/><label class="tocitem" for="menuitem-3-4"><span class="docs-label">Calibrating a ClimaLand model</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/calibration/perfect_model_site_level_calibration/">Single site perfect model</a></li><li><a class="tocitem" href="../generated/calibration/obs_site_level_calibration/">Single site observations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-5" type="checkbox"/><label class="tocitem" for="menuitem-3-5"><span class="docs-label">Running coupled simulations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/standalone/Bucket/coupled_bucket/">Coupled bucket model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-3-6" type="checkbox"/><label class="tocitem" for="menuitem-3-6"><span class="docs-label">For model developers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/standalone/Usage/model_tutorial/">Intro to standalone models</a></li><li><input class="collapse-toggle" id="menuitem-3-6-2" type="checkbox"/><label class="tocitem" for="menuitem-3-6-2"><span class="docs-label">Intro to multi-component models</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/standalone/Usage/LSM_single_column_tutorial/">Single column tutorial</a></li><li><a class="tocitem" href="../generated/integrated/handling_soil_fluxes/">Adjusting boundary conditions for the soil</a></li><li><a class="tocitem" href="../generated/integrated/handling_snow_fluxes/">Adjusting boundary conditions for the snow</a></li></ul></li><li><a class="tocitem" href="../generated/standalone/Usage/domain_tutorial/">Intro to ClimaLand Domains</a></li><li><a class="tocitem" href="../generated/shared_utilities/driver_tutorial/">Intro to forced site-level runs</a></li><li><a class="tocitem" href="../generated/shared_utilities/timestepping/">Intro to implicit/explicit timestepping</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Model Equations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Vegetation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1-1"><span class="docs-label">Radiative transfer</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/vegetation/radiative_transfer/beer_model/">Beer model</a></li><li><a class="tocitem" href="../standalone/pages/vegetation/radiative_transfer/twostream_model/">Two-Stream model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-1-2" type="checkbox"/><label class="tocitem" for="menuitem-4-1-2"><span class="docs-label">Photosynthesis</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/vegetation/photosynthesis/farquhar_model/">Farquhar model</a></li><li><a class="tocitem" href="../standalone/pages/vegetation/photosynthesis/pmodel/">P-model</a></li><li><a class="tocitem" href="../standalone/pages/vegetation/photosynthesis/optimality_model/">Optimality model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-1-3" type="checkbox"/><label class="tocitem" for="menuitem-4-1-3"><span class="docs-label">Stomatal conductance</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/vegetation/stomatal_conductance/medlyn_model/">Medlyn model</a></li><li><a class="tocitem" href="../standalone/pages/vegetation/photosynthesis/pmodel/">P-model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-1-4" type="checkbox"/><label class="tocitem" for="menuitem-4-1-4"><span class="docs-label">Plant hydraulics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/vegetation/plant_hydraulics/van_genuchten_model/">Van Genuchten model</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Soil</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-2-1" type="checkbox"/><label class="tocitem" for="menuitem-4-2-1"><span class="docs-label">Physics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/soil/physics/richards_model/">Richards model</a></li><li><a class="tocitem" href="../standalone/pages/soil/physics/energy_model/">Energy+Hydrology model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2-2"><span class="docs-label">Biogeochemistry</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/soil/biogeochemistry/DAMM_model/">DAMM model</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-3" type="checkbox"/><label class="tocitem" for="menuitem-4-3"><span class="docs-label">Snow</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/snow/snow_model/">Snow model</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox" checked/><label class="tocitem" for="menuitem-5"><span class="docs-label">Additional resources</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../model_structure/">Model structure</a></li><li><a class="tocitem" href="../repo_structure/">Repository structure</a></li><li><input class="collapse-toggle" id="menuitem-5-3" type="checkbox"/><label class="tocitem" for="menuitem-5-3"><span class="docs-label">Analyzing model output</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-5-3-1" type="checkbox"/><label class="tocitem" for="menuitem-5-3-1"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../diagnostics/users_diagnostics/">For users</a></li><li><a class="tocitem" href="../diagnostics/developers_diagnostics/">For developers</a></li><li><a class="tocitem" href="../diagnostics/available_diagnostics/">Available diagnostics</a></li></ul></li><li><a class="tocitem" href="../leaderboard/leaderboard/">Leaderboard</a></li></ul></li><li><a class="tocitem" href="../architectures/">Running on GPU or with MPI</a></li><li class="is-active"><a class="tocitem" href>Calibration</a><ul class="internal"><li><a class="tocitem" href="#Introduction"><span>Introduction</span></a></li><li><a class="tocitem" href="#Calibrate-a-land-model"><span>Calibrate a land model</span></a></li><li><a class="tocitem" href="#Job-script"><span>Job script</span></a></li><li><a class="tocitem" href="#Configure-your-land-calibration"><span>Configure your land calibration</span></a></li></ul></li><li><a class="tocitem" href="../restarts/">Restarting a simulation</a></li><li><input class="collapse-toggle" id="menuitem-5-7" type="checkbox"/><label class="tocitem" for="menuitem-5-7"><span class="docs-label">Software utilities</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../itime/">ITime type</a></li><li><a class="tocitem" href="../shared_utilities/">Shared utilities</a></li></ul></li><li><a class="tocitem" href="../physical_units/">Physical units</a></li><li><a class="tocitem" href="../julia/">Julia background</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-6-1" type="checkbox"/><label class="tocitem" for="menuitem-6-1"><span class="docs-label">Soil</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../APIs/Soil/">Soil Energy and Hydrology</a></li><li><a class="tocitem" href="../APIs/SoilBiogeochemistry/">Soil Biogeochemistry</a></li><li><a class="tocitem" href="../APIs/SoilAlbedo/">Soil Albedo</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-6-2" type="checkbox"/><label class="tocitem" for="menuitem-6-2"><span class="docs-label">Canopy</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../APIs/canopy/Canopy/">Canopy Models</a></li><li><a class="tocitem" href="../APIs/canopy/PlantHydraulics/">Plant Hydraulics</a></li><li><a class="tocitem" href="../APIs/canopy/Biomass/">Leaf, stem, root dynamics</a></li><li><a class="tocitem" href="../APIs/canopy/Photosynthesis/">Photosynthesis</a></li><li><a class="tocitem" href="../APIs/canopy/RadiativeTransfer/">Radiative Transfer</a></li><li><a class="tocitem" href="../APIs/canopy/CanopyEnergy/">Energy</a></li><li><a class="tocitem" href="../APIs/canopy/StomatalConductance/">Stomatal Conductance</a></li><li><a class="tocitem" href="../APIs/canopy/AutotrophicRespiration/">Autotrophic Respiration</a></li></ul></li><li><a class="tocitem" href="../APIs/SurfaceWater/">Surface Water Models</a></li><li><a class="tocitem" href="../APIs/Bucket/">Bucket Model</a></li><li><a class="tocitem" href="../APIs/Snow/">Snow Model</a></li><li><a class="tocitem" href="../APIs/ClimaLand/">Integrated Models</a></li><li><input class="collapse-toggle" id="menuitem-6-7" type="checkbox"/><label class="tocitem" for="menuitem-6-7"><span class="docs-label">Shared Utilities</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../APIs/AbstractModels/">Abstract Models and Functions</a></li><li><a class="tocitem" href="../APIs/Simulations/">Simulations</a></li><li><a class="tocitem" href="../APIs/Domains/">Domains</a></li><li><a class="tocitem" href="../APIs/Drivers/">Drivers</a></li><li><a class="tocitem" href="../APIs/Callbacks/">Callbacks</a></li></ul></li><li><a class="tocitem" href="../APIs/parameters/">Parameters</a></li></ul></li><li><a class="tocitem" href="../contributing/">Contributor guide</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Additional resources</a></li><li class="is-active"><a href>Calibration</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Calibration</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaLand.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaLand.jl/blob/main/docs/src/calibration.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Calibration-framework-of-the-CliMA-land-model"><a class="docs-heading-anchor" href="#Calibration-framework-of-the-CliMA-land-model">Calibration framework of the CliMA land model</a><a id="Calibration-framework-of-the-CliMA-land-model-1"></a><a class="docs-heading-anchor-permalink" href="#Calibration-framework-of-the-CliMA-land-model" title="Permalink"></a></h1><h2 id="Introduction"><a class="docs-heading-anchor" href="#Introduction">Introduction</a><a id="Introduction-1"></a><a class="docs-heading-anchor-permalink" href="#Introduction" title="Permalink"></a></h2><p>In general, models attempt to reproduce real world observations. Calibration is the process of finding the parameter set that will best reproduce real world observation.</p><p>The key ingredients in calibration are:</p><ul><li>the model we want to run;</li><li>the parameters we want to tune along with their prior distributions;</li><li>the observational data we want to reproduce and how that data is represented in the model;</li><li>the noise associated to such observational data.</li></ul><p>The process of calibrating consists of optimizing how different parameters match the given observations within the given noise. In ClimaLand, we use <code>EnsembleKalmanProcesses.jl</code> (EKP) to perform automatic calibration. Before discussing the details of EKP, we introduce the following terminology to mirror the key ingredients introduced above:</p><ul><li>a <code>forward_model</code> that runs the model for a given parameter set,</li><li>an <code>observation</code> vector that contains the data or statistics of data we want the model to reproduce,</li><li>an <code>observation_map</code> which maps the equivalent of the observation vector, but from the model output,</li><li><code>priors</code> which contains the parameters we want to calibrate (find the value that makes the model match the observation best), priors gives which parameters, but also their distribution</li><li>a covariance matrix that defines the observational error and correlations</li></ul><p><a href="https://github.com/CliMA/EnsembleKalmanProcesses.jl">EnsembleKalmanProcesses.jl</a> (EKP) is at the center of CliMA&#39;s calibration efforts. EKP implements a suite of Ensemble Kalman methods to find a (locally) optimal parameter set <code>U</code> for a model <code>G</code> to fit noisy <code>Γ</code> observational data <code>Y</code>. These methods are optimized for problems where the model <code>G</code> is computationally expensive and no analtyic derivatives are available, as in the case of weather forcasting, where Ensemble Kalman techniques have a long history of success.</p><p>Large calibration campaigns often require supercomputers and while direct use of EKP.jl is possible, CliMA&#39;s preferred approach is using <a href="https://github.com/CliMA/ClimaCalibrate.jl">ClimaCalibrate.jl</a>, a package optimized for running on compute clusters. <code>ClimaCalibrate</code> handles efficient job orchestration and abstracts the details of the underlying system, providing a simpler user experience. Consult the <a href="https://clima.github.io/ClimaCalibrate.jl/stable/">ClimaCalibrate documentation</a> for further information.</p><h2 id="Calibrate-a-land-model"><a class="docs-heading-anchor" href="#Calibrate-a-land-model">Calibrate a land model</a><a id="Calibrate-a-land-model-1"></a><a class="docs-heading-anchor-permalink" href="#Calibrate-a-land-model" title="Permalink"></a></h2><p>In this tutorial, we will perform a calibration using <code>ClimaCalibrate</code>. <code>ClimaCalibrate</code> provides an interface to <code>EnsembleKalmanProcesses.jl</code> that is more optimized for use on supercomputers. The <a href="https://clima.github.io/ClimaLand.jl/stable/generated/calibration/minimal_working_example_obs/">tutorial to calibrate a single site latent heat flux</a> shows how to perform a calibration using <code>EKP</code> directly.</p><p>The <code>calibrate</code> function is at the heart of performing a calibration with <code>ClimaCalibrate</code>:</p><pre><code class="language-julia hljs">import ClimaCalibrate

ClimaCalibrate.calibrate(
    ClimaCalibrate.WorkerBackend,
    utki,
    n_iterations,
    prior,
    output_dir,
)</code></pre><p>where the <code>utki</code> object defines your EKP configurations, for example, the default is:</p><pre><code class="language-julia hljs">EKP.EnsembleKalmanProcess(
    obs_series,
    EKP.TransformUnscented(prior, impose_prior = true),
    verbose = true,
    rng = rng,
    scheduler = EKP.DataMisfitController(terminate_at = 100),
)</code></pre><p>where <code>obs_series</code> is the &quot;truth&quot; you want to calibrate your model on. It can take many forms. For example, you may want to calibrate monthly global average of latent heat flux, monthly average at 100 random locations on land, or the annual amplitude and phase. You will create <code>obs_series</code> from some data (for example ERA5), as a vector.</p><p>Note that <code>obs_series</code> object contains the covariance matrix of the noise, which informs the uncertainties in space and time of your targeted &quot;truth&quot;. It can be set, for example, to the inter-annual variance of a variable, or a percentage (e.g., 5%) of the average of the variable, or to a flat noise (e.g., 5 W m-2 for latent heat). This will inform the EKP algorithm that if the model is within the target plus or minus the noise at specific space and time, the goal is reached.</p><ul><li><p><code>TransformUnscented.Unscented</code> is a method in EKP, that requires <code>2p + 1</code> ensemble members for each iteration, where <code>p</code> is the number of parameters. For more information, read the <a href="https://clima.github.io/EnsembleKalmanProcesses.jl/stable/unscented_kalman_inversion/">EKP documentation for that method</a>.</p></li><li><p><code>verbose = true</code> is a setting that writes information about your calibration run to a log file.</p></li><li><p><code>rng</code> is a set random seed.</p></li><li><p><code>Scheduler</code> is a EKP setting for timestepping, please read <a href="https://clima.github.io/EnsembleKalmanProcesses.jl/stable/learning_rate_scheduler/">EKP schedulers documentation</a>.</p></li><li><p><code>ClimaCalibrate.WorkerBackend</code> defines how to interact with the underlying compute system. For other possible backends (for example, <code>JuliaBackend</code>, <code>ClimaGPUBackend</code>, or <code>DerechoBackend</code>), see the <a href="https://clima.github.io/ClimaCalibrate.jl/stable/backends/">backend documentation in ClimaCalibrate</a>.</p></li></ul><p>Each backend is optimized for specific use cases and computing resources. The backend system is implemented through Julia&#39;s multiple dispatch, so that code written for one environment can seamlessly be ported to a new/different environments.</p><ul><li><code>prior</code> is the distribution of the parameters you want to calibrate. For example, if you want to calibrate two parameters called <code>sc</code> and <code>pc</code>, you would define your priors like this, for example:</li></ul><pre><code class="language-julia hljs">prior_sc = EKP.constrained_gaussian(&quot;sc&quot;, 5e-6, 5e-4, 0, Inf);
prior_pc = EKP.constrained_gaussian(&quot;pc&quot;, -2e6, 1e6, -Inf, Inf);
prior = EKP.combine_distributions([prior_sc, prior_pc]);</code></pre><p>For more documentation about prior distribution, see <a href="https://clima.github.io/EnsembleKalmanProcesses.jl/stable/parameter_distributions/">this EKP documentation page</a>.</p><ul><li><p><code>n_iterations</code> is the number of times your priors distribution will be updated, at each iteration your model is run for  the number of <code>ensemble_size</code>. So in total, your model will be run <code>ensemble_size</code> * <code>n_iterations</code>.</p></li><li><p><code>output_dir</code> is the path to your calibration output directory. Inside this folder, the parameter set of each ensemble member for each iteration is stored, as well as the output of your model simulations. For example, if you ran a calibration with 1 iteration and 2 members, output_dir would be structured like this:</p></li></ul><pre><code class="nohighlight hljs">.
├── iteration_000
│   ├── eki_file.jld2
│   ├── G_ensemble.jld2
│   ├── member_001
│   │   ├── global_diagnostics
│   │   │   ├── output_0000
│   │   │   │   ├── lhf_1M_average.nc
│   │   │   │   ├── lwu_1M_average.nc
│   │   │   │   ├── shf_1M_average.nc
│   │   │   │   └── swu_1M_average.nc
│   │   │   └── output_active -&gt; output_0000
│   │   └── parameters.toml
│   ├── member_002
│   │   ├── global_diagnostics
│   │   │   ├── output_0000
│   │   │   │   ├── lhf_1M_average.nc
│   │   │   │   ├── lwu_1M_average.nc
│   │   │   │   ├── shf_1M_average.nc
│   │   │   │   └── swu_1M_average.nc
│   │   │   └── output_active -&gt; output_0000
│   │   └── parameters.toml
├── iteration_001
│   ├── eki_file.jld2
│   ├── G_ensemble.jld2
│   ├── member_001
│   │   ├── global_diagnostics
│   │   │   ├── output_0000
│   │   │   │   ├── lhf_1M_average.nc
│   │   │   │   ├── lwu_1M_average.nc
│   │   │   │   ├── shf_1M_average.nc
│   │   │   │   └── swu_1M_average.nc
│   │   │   └── output_active -&gt; output_0000
│   │   └── parameters.toml
│   ├── member_002
│   │   ├── global_diagnostics
│   │   │   ├── output_0000
│   │   │   │   ├── lhf_1M_average.nc
│   │   │   │   ├── lwu_1M_average.nc
│   │   │   │   ├── shf_1M_average.nc
│   │   │   │   └── swu_1M_average.nc
│   │   │   └── output_active -&gt; output_0000
│   │   └── parameters.toml</code></pre><p>Each iteration contains directories for each member, inside which you can find the parameters value inside <code>parameters.toml</code>, and model outputs inside <code>global_diagnostics</code>.</p><p>Two additional functions need to be defined in order to run <code>ClimaCalibrate.calibrate</code>. <code>ClimaCalibrate.forward_model(iteration, member)</code> and <code>ClimaCalibrate.observation_map(iteration)</code>. The <code>ClimaCalibrate.forward_model(iteration, member)</code> needs to generate your model output for a specific iteration and member. The <code>ClimaCalibrate.observation_map(iteration)</code> needs to return your loss, a vector of the same format as <code>observations</code> but created with your model output (for example, monthly average of latent heat flux), for all members. To make this easier, it can be useful to implement a <code>process_member_data(root_path)</code> function that generates one member output from your model output path.</p><p>Once you have defined <code>ClimaCalibrate.forward_model</code>, <code>ClimaCalibrate.observation_map</code>, <code>output_dir</code>, <code>noise</code>, <code>observations</code>, <code>n_iterations</code>, <code>ensemble_size</code>, and your backend, you can call <code>ClimaCalibrate.calibrate</code>!</p><h2 id="Job-script"><a class="docs-heading-anchor" href="#Job-script">Job script</a><a id="Job-script-1"></a><a class="docs-heading-anchor-permalink" href="#Job-script" title="Permalink"></a></h2><p>A calibration job will likely take hours to complete, so you will probably have to submit a job with a job scheduler. Below is an example job .pbs script (for PBS, e.g., Derecho):</p><pre><code class="language-bash hljs">#!/bin/bash
#PBS -N derecho_calibration
#PBS -o output.txt
#PBS -e error.txt
#PBS -l walltime=10:00:00
#PBS -l select=1:ncpus=64:ngpus=4

## Account number for CliMA
#PBS -A UCIT0011
#PBS -q main

module load climacommon
# Run your command
export CLIMACOMMS_DEVICE=&quot;CUDA&quot;
export CLIMACOMMS_CONTEXT=&quot;SINGLETON&quot;
julia --project=.buildkite -e &#39;using Pkg; Pkg.instantiate(;verbose=true)&#39;

julia --project=.buildkite/ experiments/calibration/run_calibration.jl</code></pre><p>and below is a example job .sh script (for Slurm, e.g., central or clima):</p><pre><code class="language-bash hljs">#!/bin/bash
#SBATCH --job-name=slurm_calibration
#SBATCH --output=output.txt
#SBATCH --error=error.txt
#SBATCH --time=12:00:00
#SBATCH --ntasks=5
#SBATCH --cpus-per-task=4
#SBATCH --gpus-per-task=1

# Set environment variables for CliMA
export CLIMACOMMS_DEVICE=&quot;CUDA&quot;
export CLIMACOMMS_CONTEXT=&quot;SINGLETON&quot;

# Build and run the Julia code
module load climacommon
julia --project=.buildkite -e &#39;using Pkg; Pkg.instantiate(;verbose=true)&#39;
julia --project=.buildkite/ experiments/calibration/run_calibration.jl</code></pre><p>where <code>run_calibration.jl</code> is a script that set up the calibration and call <code>ClimaCalibrate.calibrate</code>. You would start the job with a command such as <code>qsub name_of_job_script</code> for PBS or <code>sbatch name_of_job_script</code> for Slurm, and a few hours later, you would get a calibrated parameter set. You can check the status of your job with <code>qstat -u username</code> of PBS or <code>squeue -u username</code> on Slurm.</p><p>Note that with the default EKP configuration, UTKI, the number of ensemble is set by the number of parameters, as explained in the documentation above. The number of workers (if you use the worker backend) is automatically set to that numbers, so that all members are run in parallel for each iteration.</p><h2 id="Configure-your-land-calibration"><a class="docs-heading-anchor" href="#Configure-your-land-calibration">Configure your land calibration</a><a id="Configure-your-land-calibration-1"></a><a class="docs-heading-anchor-permalink" href="#Configure-your-land-calibration" title="Permalink"></a></h2><p>For configuring the land calibration, you can configure the optimization method used by EnsembleKalmanProcesses.jl, the observations and how they are preprocessed, and the simulation itself. For most settings, you can modify the <code>CalibrateConfig</code> struct. See the example below.</p><pre><code class="language-julia hljs">CalibrateConfig(;
    short_names = [&quot;swu&quot;],
    minibatch_size = 2,
    n_iterations = 10,
    sample_date_ranges = [(&quot;2007-12-1&quot;, &quot;2008-9-1&quot;),
                          (&quot;2008-12-1&quot;, &quot;2009-9-1&quot;),
                          (&quot;2009-12-1&quot;, &quot;2010-9-1&quot;),
                          (&quot;2010-12-1&quot;, &quot;2011-9-1&quot;)],
    extend = Dates.Month(3),
    spinup = Dates.Month(3),
    nelements = (101, 15),
    output_dir = &quot;experiments/calibration/land_model&quot;,
    rng_seed = 42,
)</code></pre><p>With the configuration above, a calibration is being done using the <code>swu</code> observation. The calibration will run for 10 iterations, and each iteration will use a minibatch size of 2. The start and end dates of the simulation is automatically determined by <code>sample_date_ranges</code>, <code>spinup</code>, and <code>extend</code>. The amount to spin up the simulation for is three months and the amount to run the simulation for past the dates in <code>sample_date_ranges</code> is also three months. Since the minibatch size is 2, the first iteration of the calibration will run from 1 September 2007 to 1 December 2009 and the second iteration of the calibration is 1 September 2009 to 1 December 2011. Afterward, the iterations will repeat, so the third iteration will be the same as the first iteration, the fourth iteration will be the same as the second iteration, and so on.</p><p>The period chosen for <code>extend</code> is ensure that all the data is gathered. If you are calibrating against seasonal averages, then <code>extend</code> should be 3 months and if you are calibrating against monthly averages, then <code>extend</code> should be 1 month. For more information, see the sections <a href="#Data-pipelines">Data pipelines</a> and <a href="#Simulation-settings">Simulation settings</a>.</p><p>The number of horizontal and vertical elements to use for the simulation is determined by <code>nelements</code>. The calibration is saved at <code>output_dir</code> and the random number generator is seeded by <code>rng_seed</code>.</p><h3 id="EKP-settings"><a class="docs-heading-anchor" href="#EKP-settings">EKP settings</a><a id="EKP-settings-1"></a><a class="docs-heading-anchor-permalink" href="#EKP-settings" title="Permalink"></a></h3><p>In <code>CalibrateConfig</code>, you can modify the number of iterations via <code>n_iterations</code> and the size of the minibatch by <code>minibatch_size</code>. For reproducibility, you can pass in an integer for <code>rng_seed</code> which is used internally by EnsembleKalmanProcesses.jl to seed the random number generator.</p><p>For the land calibration, the default optimization method is <code>EnsembleKalmanProcesses.TransformUnscented</code> and the default scheduler is <code>EKP.DataMisfitController</code>. To change this optimization method or change the scheduler, you need to go to the <code>experiments/calibration/run_calibration.jl</code> file and modify it there. For more information about the different optimization methods, see <a href="https://clima.github.io/EnsembleKalmanProcesses.jl/stable/">EnsembleKalmanProcesses.jl</a> for more information.</p><h3 id="Observation-settings"><a class="docs-heading-anchor" href="#Observation-settings">Observation settings</a><a id="Observation-settings-1"></a><a class="docs-heading-anchor-permalink" href="#Observation-settings" title="Permalink"></a></h3><p>In <code>CalibrateConfig</code>, you can modify which observations that are used via <code>short_names</code>. As of now, the currently supported observations for calibration are seasonal averages of <code>lhf</code>, <code>shf</code>, <code>lwu</code>, and <code>swu</code>. See the <a href="#Data-pipelines">Data pipelines</a> on how to add more variables.</p><p>Observations are generated with <code>generate_observations.jl</code>. To generate observations, you can run</p><pre><code class="language-julia hljs">julia --project=.buildkite experiments/calibration/generate_observations.jl`</code></pre><div class="admonition is-info" id="When-do-I-need-to-generate-observations?-b804213cb1750b62"><header class="admonition-header">When do I need to generate observations?<a class="admonition-anchor" href="#When-do-I-need-to-generate-observations?-b804213cb1750b62" title="Permalink"></a></header><div class="admonition-body"><p>Whenever <code>nelements</code>, <code>sample_date_ranges</code>, <code>short_names</code>, or the preprocessing of any of the variables change, then you must regenerate the observations!</p></div></div><p>Each observation contains time series data of the variables from ERA5 and a covariance matrix. You can adjust <code>sample_date_ranges</code> if you want to calibrate over a particular year or over multiple years for example.</p><div class="admonition is-info" id="What-can-be-passed-for-sample_date_ranges?-e6defb2dc43c4ef3"><header class="admonition-header">What can be passed for `sample_date_ranges`?<a class="admonition-anchor" href="#What-can-be-passed-for-sample_date_ranges?-e6defb2dc43c4ef3" title="Permalink"></a></header><div class="admonition-body"><p>The sample date ranges should be times from the time series data of the observations. For example, when using seasonal averages, the times passed must be the first day of December, March, June, or September. The seasons are December to February (DJF), March to May (MAM), June to August (JJA), and September to November (SON). The convention for time is use the first time of the time reduction.</p></div></div><p>To change the covariance matrix, you need to go to <code>generate_observations.jl</code> and modify the covariance matrix that is passed in. See <a href="https://clima.github.io/ClimaCalibrate.jl/stable/api/#Observation-Recipe-Interface">ClimaCalibrate.jl documentation</a> for a list of different covariance matrices that can be used.</p><h4 id="Data-pipelines"><a class="docs-heading-anchor" href="#Data-pipelines">Data pipelines</a><a id="Data-pipelines-1"></a><a class="docs-heading-anchor-permalink" href="#Data-pipelines" title="Permalink"></a></h4><div class="admonition is-info" id="Data-preprocessing-e0ce09ba024061ee"><header class="admonition-header">Data preprocessing<a class="admonition-anchor" href="#Data-preprocessing-e0ce09ba024061ee" title="Permalink"></a></header><div class="admonition-body"><p>The data preprocessing uses ClimaAnalysis.jl. See the <a href="https://clima.github.io/ClimaAnalysis.jl/stable/api/">ClimaAnalysis.jl documentation</a> for functions you can use for preprocessing.</p></div></div><p>To add additional variables or change how a variable is preprocessed, you must add the variable to the data sources and specify how the variable should be preprocessed. The name of the variable should match the name in the diagnostics. As of now, each variable from the ERA5 data is loaded by the function <code>get_era5_obs_var_dict</code> in <code>ext/land_sim_vis/leaderboard/data_sources.jl</code>. See the documentation of <code>get_obs_var_dict</code> for how to add a new variable. In addition, you should also add the same variable to <code>get_sim_var_dict</code> in the same file as before.</p><p>Further preprocessing is done in the function <code>preprocess_single_era5_var</code> in <code>generate_observations.jl</code>. After adding the variable, you should specify any additional preprocessing. For example, if you want seasonal averages, you should use <code>ClimaAnalysis.average_season_across_time</code>. Furthermore, you should check the units of the variable, ensure that the grid and mask are the same between the simulation and observational data, and ensure the conventions for times are the same. Finally, the same preprocessing should be applied between both observational and simulation data. Preprocessing the observational data is done in <code>preprocess_single_era5_var</code> in <code>experiments/calibration/generate_observations.jl</code> and preprocessing the simulation data is done in <code>process_member_data</code> in <code>experiments/calibration/observation_map.jl</code>.</p><div class="admonition is-info" id="Time-conventions-41c87d0394361c21"><header class="admonition-header">Time conventions<a class="admonition-anchor" href="#Time-conventions-41c87d0394361c21" title="Permalink"></a></header><div class="admonition-body"><p>Different data sources have different conventions for time. For example, data sources use January 1, January 15, and Feburary 1 for the monthly average of January. For the diagnostics saved from a CliMA simulation, the current convention is to save the monthly average on the Feburary 1. You must ensure that the time conventions are the same. For calibration, we choose the start of the time reduction, so for this example, the time associated with the monthly average of January is January 1. For seasonal averages, the dates would be December 1, March 1, June 1, and September 1.</p></div></div><h3 id="Simulation-settings"><a class="docs-heading-anchor" href="#Simulation-settings">Simulation settings</a><a id="Simulation-settings-1"></a><a class="docs-heading-anchor-permalink" href="#Simulation-settings" title="Permalink"></a></h3><p>In <code>CalibrateConfig</code>, you can modify the resolution of the model via <code>nelements</code>. To change the directory of where the calibration starts, you can change <code>output_dir</code>, whose default is <code>experiments/calibration/land_model</code>.</p><p>For adjusting the start and end dates of the simulation, you can change <code>spinup</code> and <code>extend</code>.</p><div class="admonition is-info" id="How-are-the-start-and-end-dates-of-the-simulation-chosen?-a554b0f52575cf85"><header class="admonition-header">How are the start and end dates of the simulation chosen?<a class="admonition-anchor" href="#How-are-the-start-and-end-dates-of-the-simulation-chosen?-a554b0f52575cf85" title="Permalink"></a></header><div class="admonition-body"><p>The start and end dates of a simulation is automatically inferred from the <code>sample_date_ranges</code>. For example, suppose that <code>sample_date_ranges = [(&quot;2007-12-1&quot;, &quot;2008-9-1&quot;), (&quot;2008-12-1&quot;, &quot;2008-9-1)]</code> and the minibatch size is 2. The start and end dates are <code>2007-12-1</code> to <code>2008-9-1</code>. This should cover the time ranges of the observational data. However, observe that the simulation output may not be realistic at the beginning of the simulation while the land model is equilibrating and the end date is not correct, because of the time convention we chosen earlier. To solve the first problem, you can specify how the long the model should spin up for with <code>spinup</code> in the <code>CalibrateConfig</code>. For the second problem, you can make the simulation extend past <code>2008-9-1</code> with <code>extend</code>. For calibrating with monthly averages, <code>extend</code> should be <code>Dates.Month(1)</code> and for calibrating with seasonal averages, <code>extend</code> should be <code>Dates.Month(3)</code>.</p></div></div></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../architectures/">« Running on GPU or with MPI</a><a class="docs-footer-nextpage" href="../restarts/">Restarting a simulation »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.14.1 on <span class="colophon-date" title="Tuesday 23 September 2025 01:12">Tuesday 23 September 2025</span>. Using Julia version 1.11.7.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
