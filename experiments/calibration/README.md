# Calibration of land model on Derecho

This folder contains scripts to calibrate a land model (bucket or full land) on Derecho HPC.

The folders are organized as such:

```
.
├── global_bucket
│   ├── calibrate_bucket.jl
│   ├── forward_model.jl
│   └── observation_map.jl
├── global_land
│   ├── calibrate_land.jl
│   ├── forward_model.jl
│   └── observation_map.jl
├── job_scripts
│   ├── calibrate_bucket.pbs
│   └── calibrate_land.pbs
└── shared
    ├── make_training_locations.jl
    ├── observation_data_global.jl
    ├── observation_data_locations.jl
    └── rand_locations.jl
```

## calibrate\_bucket.jl and calibrate\_land.jl

Those scripts are the main script, calling the others. They get the arguments of the ClimaCalibrate function call
for calibration

```julia
CAL.calibrate(
    CAL.WorkerBackend,
    ensemble_size,
    n_iterations,
    observations,
    noise,
    prior,
    caldir,
)
```

### forward\_model

to work, a `forward_model(iteration, member)` function needs to be defined (in forward\_model.jl), this will run
the model (bucket or land) and save the diagnostics.

### observation\_map

Furthermore, an `observation_map(iteration)` function needs to be defined (in observation\_map.jl), this will
generate your loss from the model output, in the same format as your observations from data, contained in shared/observation\_data.
For each member (parameters sample), a vector will be created from the function `process_member_data(root_path)` located in the script
observation\_map.jl.

## Calibration folder

the argument `caldir` inside CAL.calibrate() in the path to your calibration folder. This folder is generated by ClimaCalibrate and look like this,
for example, with 1 iteration and 2 members:

```
.
├── iteration_000
│   ├── eki_file.jld2
│   ├── G_ensemble.jld2
│   ├── member_001
│   │   ├── global_diagnostics
│   │   │   ├── output_0000
│   │   │   │   ├── lhf_1M_average.nc
│   │   │   │   ├── lwu_1M_average.nc
│   │   │   │   ├── shf_1M_average.nc
│   │   │   │   └── swu_1M_average.nc
│   │   │   └── output_active -> output_0000
│   │   └── parameters.toml
│   ├── member_002
│   │   ├── global_diagnostics
│   │   │   ├── output_0000
│   │   │   │   ├── lhf_1M_average.nc
│   │   │   │   ├── lwu_1M_average.nc
│   │   │   │   ├── shf_1M_average.nc
│   │   │   │   └── swu_1M_average.nc
│   │   │   └── output_active -> output_0000
│   │   └── parameters.toml
├── iteration_001
│   ├── eki_file.jld2
│   ├── G_ensemble.jld2
│   ├── member_001
│   │   ├── global_diagnostics
│   │   │   ├── output_0000
│   │   │   │   ├── lhf_1M_average.nc
│   │   │   │   ├── lwu_1M_average.nc
│   │   │   │   ├── shf_1M_average.nc
│   │   │   │   └── swu_1M_average.nc
│   │   │   └── output_active -> output_0000
│   │   └── parameters.toml
│   ├── member_002
│   │   ├── global_diagnostics
│   │   │   ├── output_0000
│   │   │   │   ├── lhf_1M_average.nc
│   │   │   │   ├── lwu_1M_average.nc
│   │   │   │   ├── shf_1M_average.nc
│   │   │   │   └── swu_1M_average.nc
│   │   │   └── output_active -> output_0000
│   │   └── parameters.toml
```

each iteration contains folders for each member, inside which you can find the parameters value inside parameters.toml, and forward\_model outputs
inside global\_diagnostics.

## Running jobs on Derecho

To run a calibration on Derecho, run the .pbs job scripts contained in experiments/calibration/job\_scripts.
for example, `qsub calibrate_land.pbs` will start a calibration for the land model. To check the state of your job,
run the command `qstat -u username` where username is your username. For more documentation about Derecho, see [CliMA
Derecho wiki](https://github.com/CliMA/ClimaModules-Derecho/wiki).

## Configuration

To understand the calibration configuration, we recommend reading the documentation of [EnsembleKalmanProcesses.jl](https://clima.github.io/EnsembleKalmanProcesses.jl/dev/)
and [ClimaCalibrate.jl](https://clima.github.io/ClimaCalibrate.jl/dev/).
