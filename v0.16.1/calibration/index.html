<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Calibration · ClimaLand.jl</title><meta name="title" content="Calibration · ClimaLand.jl"/><meta property="og:title" content="Calibration · ClimaLand.jl"/><meta property="twitter:title" content="Calibration · ClimaLand.jl"/><meta name="description" content="Documentation for ClimaLand.jl."/><meta property="og:description" content="Documentation for ClimaLand.jl."/><meta property="twitter:description" content="Documentation for ClimaLand.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.svg" alt="ClimaLand.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ClimaLand.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../getting_started/">Getting Started</a></li><li><a class="tocitem" href="../folderstructure/">Repository structure</a></li><li><input class="collapse-toggle" id="menuitem-4" type="checkbox"/><label class="tocitem" for="menuitem-4"><span class="docs-label">Tutorials</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1"><span class="docs-label">Running land simulations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-1-1" type="checkbox"/><label class="tocitem" for="menuitem-4-1-1"><span class="docs-label">Bucket LSM</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/standalone/Bucket/bucket_tutorial/">Introduction to the Land Bucket Model</a></li><li><a class="tocitem" href="../generated/standalone/Bucket/coupled_bucket/">Setting up a Coupled Simulation</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-1-2" type="checkbox"/><label class="tocitem" for="menuitem-4-1-2"><span class="docs-label">Integrated soil+canopy modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/integrated/soil_canopy_tutorial/">Coupled Canopy and Soil</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-1-3" type="checkbox"/><label class="tocitem" for="menuitem-4-1-3"><span class="docs-label">Handling interactions between model components</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/integrated/handling_soil_fluxes/">Adjusting boundary conditions for the soil</a></li><li><a class="tocitem" href="../generated/integrated/handling_snow_fluxes/">Adjusting boundary conditions for the snow</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2"><span class="docs-label">Running standalone component simulations</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-4-2-1" type="checkbox"/><label class="tocitem" for="menuitem-4-2-1"><span class="docs-label">Soil modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/standalone/Soil/boundary_conditions/">Boundary conditions</a></li><li><a class="tocitem" href="../generated/standalone/Soil/richards_equation/">Richards Equation</a></li><li><a class="tocitem" href="../generated/standalone/Soil/soil_energy_hydrology/">Energy and Hydrology</a></li><li><input class="collapse-toggle" id="menuitem-4-2-1-4" type="checkbox"/><label class="tocitem" for="menuitem-4-2-1-4"><span class="docs-label">Phase Changes</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/standalone/Soil/freezing_front/">Modeling a freezing front in unsaturated soil</a></li><li><a class="tocitem" href="../generated/standalone/Soil/phase_change_analytic/">The Stefan problem</a></li></ul></li><li><a class="tocitem" href="../generated/standalone/Soil/layered_soil/">Layered Soil</a></li><li><a class="tocitem" href="../generated/standalone/Soil/evaporation/">Coarse Sand Evaporation</a></li><li><a class="tocitem" href="../generated/standalone/Soil/evaporation_gilat_loess/">Gilat Loess Evaporation</a></li><li><a class="tocitem" href="../generated/standalone/Soil/sublimation/">Bare soil site</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2-2" type="checkbox"/><label class="tocitem" for="menuitem-4-2-2"><span class="docs-label">Canopy modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/standalone/Canopy/canopy_tutorial/">Standalone Canopy</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-2-3" type="checkbox"/><label class="tocitem" for="menuitem-4-2-3"><span class="docs-label">Snow Modeling</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/standalone/Snow/base_tutorial/">Seasonal Snow Timeseries Generation with a Neural Network</a></li><li><a class="tocitem" href="../generated/standalone/Snow/data_tutorial/">Scraping SNOTEL Data</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-3" type="checkbox"/><label class="tocitem" for="menuitem-4-3"><span class="docs-label">Calibrating your ClimaLand model</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/calibration/minimal_working_example/">Single site perfect model</a></li><li><a class="tocitem" href="../generated/calibration/minimal_working_example_obs/">Single site observations</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-4-4" type="checkbox"/><label class="tocitem" for="menuitem-4-4"><span class="docs-label">For model developers</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../generated/standalone/Usage/model_tutorial/">Intro to standalone models</a></li><li><a class="tocitem" href="../generated/standalone/Usage/LSM_single_column_tutorial/">Intro to multi-component models</a></li><li><a class="tocitem" href="../generated/standalone/Usage/domain_tutorial/">Intro to ClimaLand Domains</a></li><li><a class="tocitem" href="../generated/shared_utilities/driver_tutorial/">Intro to forced site-level runs</a></li><li><a class="tocitem" href="../generated/shared_utilities/timestepping/">Intro to implicit/explicit timestepping</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5" type="checkbox"/><label class="tocitem" for="menuitem-5"><span class="docs-label">Standalone models</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-5-1" type="checkbox"/><label class="tocitem" for="menuitem-5-1"><span class="docs-label">Vegetation</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-5-1-1" type="checkbox"/><label class="tocitem" for="menuitem-5-1-1"><span class="docs-label">Radiative transfer</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/vegetation/radiative_transfer/beer_model/">Beer model</a></li><li><a class="tocitem" href="../standalone/pages/vegetation/radiative_transfer/twostream_model/">Two-Stream model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-1-2" type="checkbox"/><label class="tocitem" for="menuitem-5-1-2"><span class="docs-label">Photosynthesis</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/vegetation/photosynthesis/farquhar_model/">Farquhar model</a></li><li><a class="tocitem" href="../standalone/pages/vegetation/photosynthesis/optimality_model/">Optimality model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-1-3" type="checkbox"/><label class="tocitem" for="menuitem-5-1-3"><span class="docs-label">Stomatal conductance</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/vegetation/stomatal_conductance/medlyn_model/">Medlyn model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-1-4" type="checkbox"/><label class="tocitem" for="menuitem-5-1-4"><span class="docs-label">Plant hydraulics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/vegetation/plant_hydraulics/van_genuchten_model/">Van Genuchten model</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2"><span class="docs-label">Soil</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-5-2-1" type="checkbox"/><label class="tocitem" for="menuitem-5-2-1"><span class="docs-label">Biogeochemistry</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/soil/biogeochemistry/DAMM_model/">DAMM model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-2-2" type="checkbox"/><label class="tocitem" for="menuitem-5-2-2"><span class="docs-label">Hydrology</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/soil/hydrology/richards_model/">Richards model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-2-3" type="checkbox"/><label class="tocitem" for="menuitem-5-2-3"><span class="docs-label">Energy</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/soil/energy/energy_model/">Energy model</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-3" type="checkbox"/><label class="tocitem" for="menuitem-5-3"><span class="docs-label">Snow</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/snow/snow_model/">Snow model</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-5-4" type="checkbox"/><label class="tocitem" for="menuitem-5-4"><span class="docs-label">SurfaceWater</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../standalone/pages/surface_water/surface_water_model/">Surface water model</a></li></ul></li></ul></li><li><input class="collapse-toggle" id="menuitem-6" type="checkbox"/><label class="tocitem" for="menuitem-6"><span class="docs-label">Diagnostics</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../diagnostics/users_diagnostics/">For users</a></li><li><a class="tocitem" href="../diagnostics/developers_diagnostics/">For developers</a></li><li><a class="tocitem" href="../diagnostics/available_diagnostics/">Available diagnostics</a></li></ul></li><li class="is-active"><a class="tocitem" href>Calibration</a><ul class="internal"><li><a class="tocitem" href="#Introduction"><span>Introduction</span></a></li><li><a class="tocitem" href="#Calibrate-a-land-model"><span>Calibrate a land model</span></a></li><li><a class="tocitem" href="#job-script"><span>job script</span></a></li><li><a class="tocitem" href="#Configure-your-calibration-job"><span>Configure your calibration job</span></a></li></ul></li><li><a class="tocitem" href="../leaderboard/leaderboard/">Leaderboard</a></li><li><a class="tocitem" href="../restarts/">Restarts</a></li><li><a class="tocitem" href="../timemanager/">Time type</a></li><li><a class="tocitem" href="../shared_utilities/">Misc. utilities</a></li><li><input class="collapse-toggle" id="menuitem-12" type="checkbox"/><label class="tocitem" for="menuitem-12"><span class="docs-label">APIs</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><input class="collapse-toggle" id="menuitem-12-1" type="checkbox"/><label class="tocitem" for="menuitem-12-1"><span class="docs-label">ClimaLand</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../APIs/ClimaLand/">ClimaLand</a></li><li><a class="tocitem" href="../APIs/shared_utilities/">Shared Utilities</a></li><li><input class="collapse-toggle" id="menuitem-12-1-3" type="checkbox"/><label class="tocitem" for="menuitem-12-1-3"><span class="docs-label">Soil</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../APIs/Soil/">Soil Energy and Hydrology</a></li><li><a class="tocitem" href="../APIs/SoilBiogeochemistry/">Soil Biogeochemistry</a></li></ul></li><li><input class="collapse-toggle" id="menuitem-12-1-4" type="checkbox"/><label class="tocitem" for="menuitem-12-1-4"><span class="docs-label">Canopy</span><i class="docs-chevron"></i></label><ul class="collapsed"><li><a class="tocitem" href="../APIs/canopy/Canopy/">Canopy Models</a></li><li><a class="tocitem" href="../APIs/canopy/PlantHydraulics/">Plant Hydraulics</a></li><li><a class="tocitem" href="../APIs/canopy/Photosynthesis/">Canopy Photosynthesis</a></li><li><a class="tocitem" href="../APIs/canopy/RadiativeTransfer/">Canopy RT</a></li><li><a class="tocitem" href="../APIs/canopy/CanopyEnergy/">Canopy Energy</a></li><li><a class="tocitem" href="../APIs/canopy/StomatalConductance/">Canopy Stomatal Conductance</a></li><li><a class="tocitem" href="../APIs/canopy/AutotrophicRespiration/">Canopy Autotrophic Respiration</a></li></ul></li><li><a class="tocitem" href="../APIs/SurfaceWater/">Surface Water Models</a></li><li><a class="tocitem" href="../APIs/Bucket/">Bucket Model</a></li><li><a class="tocitem" href="../APIs/Snow/">Snow Model</a></li></ul></li></ul></li><li><a class="tocitem" href="../Contributing/">Contribution guide</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Calibration</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Calibration</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaLand.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/CliMA/ClimaLand.jl/blob/main/docs/src/calibration.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Calibration-framework-of-the-CliMA-land-model"><a class="docs-heading-anchor" href="#Calibration-framework-of-the-CliMA-land-model">Calibration framework of the CliMA land model</a><a id="Calibration-framework-of-the-CliMA-land-model-1"></a><a class="docs-heading-anchor-permalink" href="#Calibration-framework-of-the-CliMA-land-model" title="Permalink"></a></h1><h2 id="Introduction"><a class="docs-heading-anchor" href="#Introduction">Introduction</a><a id="Introduction-1"></a><a class="docs-heading-anchor-permalink" href="#Introduction" title="Permalink"></a></h2><p>In general, models attempt to reproduce real world observations. Calibration is the process of finding the parameter set that will best reproduce real world observation.</p><p>The key ingredients in calibration are:</p><ul><li>the model we want to run;</li><li>the parameters we want to tune along with their prior distributions;</li><li>the observational data we want to reproduce and how that data is represented in the model;</li><li>the noise associated to such observational data.</li></ul><p>The process of calibrating consists of optimizing how different parameters match the given observations within the given noise. In ClimaLand, we use <code>EnsembleKalmanProcesses.jl</code> (EKP) to perform automatic calibration. Before discussing the details of EKP, we introduce the following terminology to mirror the key ingredients introduced above:</p><ul><li>a <code>forward_model</code> that runs the model for a given parameter set,</li><li>an <code>observation</code> vector that contains the data or statistics of data we want the model to reproduce,</li><li>an <code>observation_map</code> which maps the equivalent of the observation vector, but from the model output,</li><li><code>priors</code> which contains the parameters we want to calibrate (find the value that makes the model match the observation best), priors gives which parameters, but also their distribution</li><li>a covariance matrix, that defines the observational error and correlations</li></ul><p><a href="https://github.com/CliMA/EnsembleKalmanProcesses.jl">EnsembleKalmanProcesses.jl</a> (EKP) is at the center of CliMA&#39;s calibration efforts. EKP implements a suite of Ensemble Kalman methods to find a (locally) optimal parameter set <code>U</code> for a model <code>G</code> to fit noisy <code>Γ</code> observational data <code>Y</code>. These methods are optimized for problems where the model <code>G</code> is computationally expensive and no analtyic derivatives are available, as in the case of weather forcasting, where Ensemble Kalman techniques have a long history of success.</p><p>Large calibration campaigns often require supercomputers and while direct use of EKP.jl is possible, CliMA&#39;s preferred approach is using <a href="https://github.com/CliMA/ClimaCalibrate.jl">ClimaCalibrate.jl</a>, a package optimized for running on compute clusters. <code>ClimaCalibrate</code> handles efficient job orchestration and abstracts the details of the underlying system, providing a simpler user experience. Consult the <a href="https://clima.github.io/ClimaCalibrate.jl/dev/">ClimaCalibrate documentation</a> for further information.</p><h2 id="Calibrate-a-land-model"><a class="docs-heading-anchor" href="#Calibrate-a-land-model">Calibrate a land model</a><a id="Calibrate-a-land-model-1"></a><a class="docs-heading-anchor-permalink" href="#Calibrate-a-land-model" title="Permalink"></a></h2><p>In this tutorial, we will perform a calibration using <code>ClimaCalibrate</code>. <code>ClimaCalibrate</code> provides an interface to <code>EnsembleKalmanProcesses.jl</code> that is more optimized for use on supercomputers. The <a href="https://clima.github.io/ClimaLand.jl/stable/generated/calibration/minimal_working_example_obs/">tutorial to calibrate a single site latent heat flux</a> shows how to perform a calibration using <code>EKP</code> directly.</p><p>The <code>calibrate</code> function is at the heart of performing a calibration with <code>ClimaCalibrate</code>:</p><pre><code class="language-julia hljs">import ClimaCalibrate as CAL

CAL.calibrate(
    CAL.WorkerBackend,
    utki,
    n_iterations,
    prior,
    caldir,
)</code></pre><p>where the utki object defines your EKP configurations, for example, the default is:</p><pre><code class="language-julia hljs">    observationseries,
    EKP.TransformUnscented(prior, impose_prior = true);
    verbose = true,
    rng,
    scheduler = EKP.DataMisfitController(terminate_at = 100),</code></pre><p>where <code>observationseries</code> is the &quot;truth&quot; you want to calibrate your model on. It can take many forms. For example, you may want to calibrate your land model latent heat flux (lhf), the observations could be monthly global average of lhf, or monthly average at 100 random locations on land, or the annual amplitude and phase... You will create <code>observationsseries</code> from some data (for example ERA5), as a vector.</p><p>note that <code>observationseries</code> object contains the covariance matrix of the noise, which informs the uncertainties in space and time of your targeted &quot;truth&quot;. It can be set, for example, to the inter-annual variance of a variable, or to the average of the variable times a % (e.g., 5%), or to a flat noise (for example, 5 W m-2 for latent heat). This will inform the EKP algorithm that if the model is within the target +- noise at specific space and time, the goal is reached.</p><p><code>TransformUnscented.Unscented</code> is a method in EKP, that requires <code>2 x number of parameters + 1</code> ensemble members (<code>ensembe_size</code>, the number of parameter set drawn for your prior distribution tested at each iteration). For more information, read the <a href="https://clima.github.io/EnsembleKalmanProcesses.jl/dev/unscented_kalman_inversion/">EKP documentation for that method</a>.</p><p><code>verbose = true</code> is a setting that writes information about your calibration run to a log file.</p><p><code>rng</code> is a set random seed.</p><p><code>Scheduler</code> is a EKP setting for timestepping, please read <a href="https://clima.github.io/EnsembleKalmanProcesses.jl/dev/learning_rate_scheduler/">EKP schedulers documentations</a>.</p><p><code>CAL.WorkerBackend</code> defines how to interact with the underlying compute system. For other possible backends (for example, <code>JuliaBackend</code>, <code>ClimaGPUBackend</code>, or <code>DerechoBackend</code>), see <a href="https://clima.github.io/ClimaCalibrate.jl/dev/backends/">this doc page</a>.</p><p>Each backend is optimized for specific use cases and computing resources. The backend system is implemented through Julia&#39;s multiple dispatch, so that code written for one computer can seamlessly be ported to a new/different environments.</p><p><code>prior</code> is the distribution of the parameters you want to calibrate. For example, if you want to calibrate two parameters called <code>sc</code> and <code>pc</code>, you would define your priors like this, for example:</p><pre><code class="language-julia hljs">prior_sc = EKP.constrained_gaussian(&quot;sc&quot;, 5e-6, 5e-4, 0, Inf);
prior_pc = EKP.constrained_gaussian(&quot;pc&quot;, -2e6, 1e6, -Inf, Inf);
prior = EKP.combine_distributions([prior_sc, prior_pc]);</code></pre><p>For more documentation about prior distribution, see <a href="https://clima.github.io/EnsembleKalmanProcesses.jl/dev/parameter_distributions/">this EKP documentation page</a>.</p><p><code>n_iterations</code> is the number of times your priors distribution will be updated, at each iteration your model is run for the number of <code>ensemble_size</code>. So in total, your model will be run <code>ensemble_size</code> * <code>n_iterations</code>.</p><p><code>caldir</code> is the path to your calibration output directory. For example <code>calibration_output</code>. Inside this folder, the parameter set of each iteration * member will be stored, as well as the output of your model simulations. For example, if you ran a calibration with 1 iteration and 2 members, caldir would be structured like this:</p><pre><code class="nohighlight hljs">.
├── iteration_000
│   ├── eki_file.jld2
│   ├── G_ensemble.jld2
│   ├── member_001
│   │   ├── global_diagnostics
│   │   │   ├── output_0000
│   │   │   │   ├── lhf_1M_average.nc
│   │   │   │   ├── lwu_1M_average.nc
│   │   │   │   ├── shf_1M_average.nc
│   │   │   │   └── swu_1M_average.nc
│   │   │   └── output_active -&gt; output_0000
│   │   └── parameters.toml
│   ├── member_002
│   │   ├── global_diagnostics
│   │   │   ├── output_0000
│   │   │   │   ├── lhf_1M_average.nc
│   │   │   │   ├── lwu_1M_average.nc
│   │   │   │   ├── shf_1M_average.nc
│   │   │   │   └── swu_1M_average.nc
│   │   │   └── output_active -&gt; output_0000
│   │   └── parameters.toml
├── iteration_001
│   ├── eki_file.jld2
│   ├── G_ensemble.jld2
│   ├── member_001
│   │   ├── global_diagnostics
│   │   │   ├── output_0000
│   │   │   │   ├── lhf_1M_average.nc
│   │   │   │   ├── lwu_1M_average.nc
│   │   │   │   ├── shf_1M_average.nc
│   │   │   │   └── swu_1M_average.nc
│   │   │   └── output_active -&gt; output_0000
│   │   └── parameters.toml
│   ├── member_002
│   │   ├── global_diagnostics
│   │   │   ├── output_0000
│   │   │   │   ├── lhf_1M_average.nc
│   │   │   │   ├── lwu_1M_average.nc
│   │   │   │   ├── shf_1M_average.nc
│   │   │   │   └── swu_1M_average.nc
│   │   │   └── output_active -&gt; output_0000
│   │   └── parameters.toml</code></pre><p>each iteration contains folders for each member, inside which you can find the parameters value inside <code>parameters.toml</code>, and model outputs inside <code>global_diagnostics</code>.</p><p>Two additional functions need to be defined in order to run <code>CAL.calibrate</code>. <code>CAL.forward_model(iteration, member)</code> and <code>observation_map(iteration)</code>. The <code>CAL.forward_model(iteration, member)</code> needs to generate your model output for a specific iteration and member. The <code>observation_map(iteration)</code> needs to return your loss, a vector of the same format as <code>observations</code> but created with your model output (for example, monthly average of latent heat flux), for all members. To make this easier, it can be useful to implement a <code>process_member_data(root_path)</code> function that generates one member output from your model output path.</p><p>Once you have defined <code>CAL.forward_model</code>, <code>CAL.observation_map</code>, <code>caldir</code>, <code>noise</code>, <code>observations</code>, <code>n_iterations</code>, <code>ensemble_size</code>, and your backend, you can call <code>CAL.calibrate</code>!</p><h2 id="job-script"><a class="docs-heading-anchor" href="#job-script">job script</a><a id="job-script-1"></a><a class="docs-heading-anchor-permalink" href="#job-script" title="Permalink"></a></h2><p>A calibration job will likely take hours to complete, so you will probably have to submit a job with a job scheduler. Below is an example job .pbs script, slurm would be slightly different.</p><pre><code class="nohighlight hljs">#!/bin/bash
#PBS -N derecho_calibration
#PBS -o output.txt
#PBS -e error.txt
#PBS -l walltime=10:00:00
#PBS -l select=1:ncpus=64:ngpus=4

## Account number for CliMA
#PBS -A UCIT0011
#PBS -q main

module load climacommon
# Run your command
export CLIMACOMMS_DEVICE=&quot;CUDA&quot;
export CLIMACOMMS_CONTEXT=&quot;SINGLETON&quot;
julia --project=.buildkite -e &#39;using Pkg; Pkg.instantiate(;verbose=true)&#39;

julia --project=.buildkite/ experiments/calibration/global_land/calibrate_land.jl</code></pre><p>where <code>calibrate_land.jl</code> is a script that generates all the arguments needed and eventually calls <code>CAL.calibrate</code>. You would start the job with a command such as <code>qsub name_of_job_script</code>, and a few hours later, you would get a calibrated parameter set.</p><p>Note that with the default EKP configuration, UTKI, the number of ensemble is set by the number of parameters, as explained in the documentation above. The number of workers (if you use the worker backend) is automatically set to that numbers, so that all members are run in parallel for each iteration.</p><h2 id="Configure-your-calibration-job"><a class="docs-heading-anchor" href="#Configure-your-calibration-job">Configure your calibration job</a><a id="Configure-your-calibration-job-1"></a><a class="docs-heading-anchor-permalink" href="#Configure-your-calibration-job" title="Permalink"></a></h2><p>To run a calibration, you can modify the following objects in <code>calibrate_land.jl</code>:</p><ul><li>include <code>forward_model.jl</code> or <code>forward_model_bucket.jl</code>, depending on which model you want to calibrate</li><li><code>variable_list</code>: choose the variables you want to calibrate. For example, <code>[&quot;swu&quot;]</code> or <code>[&quot;lhf&quot;, &quot;shf&quot;]</code></li><li><code>n_iterations</code>: how many iterations you want to run</li><li><code>spinup_period</code>: the time length of your spinup</li><li><code>start_date</code>: the start date of the calibration</li><li><code>nelements</code>: to adjust the model resolution (n<em>horizontal elements, n</em>vertical elements)</li><li><code>caldir</code>: you can change the name and path of your calibration output directory</li><li><code>training_locations</code>: the default is all locations on land, but you can change this to a subset of land coordinates</li></ul><p>You should also modify the files:</p><ul><li><code>priors.jl</code>, to give your parameters and their distribution</li><li><code>forward_mode.jl</code> or <code>forward_model_bucket.jl</code>, to ensure it reads the parameters from <code>priors.jl</code> and uses them</li></ul><p>other things to consider:</p><ul><li><code>observationseries_era5.jl</code>: currently the target data is era5. This could be changed to another dataset, or a perfect model target</li><li><code>observationseries_era5.jl</code>: the noise is currently set to 5^2 (flat noise, in W m^-2), this should be changed to desired noise</li><li>you could change the EnsembleKalmanProcesses settings, set in <code>EKP.EnsembleKalmanProcesses()</code> in <code>calibrate_land.jl</code></li><li>you can adjust the ClimaCalibrate backend, see the <a href="https://clima.github.io/ClimaCalibrate.jl/dev/backends/">documentation</a></li><li>Because the variable names are currently different in era5 file, you may have to add variables to map in observationseries_era5.jl (for example, &quot;lhf&quot; =&gt; &quot;mslhf&quot;)</li></ul><p>Also, note that currently:</p><ul><li>the temporal resolution of observation_maps are seasonal (3 months average)</li><li>the length of calibration is 1 year (data used after spinup)</li><li>the entire globe is used</li></ul><p>These could also be changed in the code, but would currently requires significant changes.</p><p>Finally, note that the HPC job script and command will slightly differ between slurm (for example central or clima) and pbs (for example derecho).</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../diagnostics/available_diagnostics/">« Available diagnostics</a><a class="docs-footer-nextpage" href="../leaderboard/leaderboard/">Leaderboard »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.11.1 on <span class="colophon-date" title="Wednesday 14 May 2025 01:04">Wednesday 14 May 2025</span>. Using Julia version 1.11.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
